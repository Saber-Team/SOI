(function(window){"use strict";var CanvasPrototype=window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype,hasBlobConstructor=window.Blob&&function(){try{return Boolean(new Blob)}catch(e){return false}}(),hasArrayBufferViewSupport=hasBlobConstructor&&window.Uint8Array&&function(){try{return new Blob([new Uint8Array(100)]).size===100}catch(e){return false}}(),BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,dataURLtoBlob=(hasBlobConstructor||BlobBuilder)&&window.atob&&window.ArrayBuffer&&window.Uint8Array&&function(dataURI){var byteString,arrayBuffer,intArray,i,mimeString,bb;if(dataURI.split(",")[0].indexOf("base64")>=0){byteString=atob(dataURI.split(",")[1])}else{byteString=decodeURIComponent(dataURI.split(",")[1])}arrayBuffer=new ArrayBuffer(byteString.length);intArray=new Uint8Array(arrayBuffer);for(i=0;i<byteString.length;i+=1){intArray[i]=byteString.charCodeAt(i)}mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0];if(hasBlobConstructor){return new Blob([hasArrayBufferViewSupport?intArray:arrayBuffer],{type:mimeString})}bb=new BlobBuilder;bb.append(arrayBuffer);return bb.getBlob(mimeString)};if(window.HTMLCanvasElement&&!CanvasPrototype.toBlob){if(CanvasPrototype.mozGetAsFile){CanvasPrototype.toBlob=function(callback,type,quality){if(quality&&CanvasPrototype.toDataURL&&dataURLtoBlob){callback(dataURLtoBlob(this.toDataURL(type,quality)))}else{callback(this.mozGetAsFile("blob",type))}}}else if(CanvasPrototype.toDataURL&&dataURLtoBlob){CanvasPrototype.toBlob=function(callback,type,quality){callback(dataURLtoBlob(this.toDataURL(type,quality)))}}}window.dataURLtoBlob=dataURLtoBlob})(window);(function(window,undef){"use strict";var gid=1,noop=function(){},document=window.document,doctype=document.doctype||{},userAgent=window.navigator.userAgent,safari=/safari\//i.test(userAgent)&&!/chrome\//i.test(userAgent),apiURL=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL&&webkitURL,Blob=window.Blob,File=window.File,FileReader=window.FileReader,FormData=window.FormData,XMLHttpRequest=window.XMLHttpRequest,jQuery=window.jQuery,html5=!!(File&&(FileReader&&(window.Uint8Array||FormData||XMLHttpRequest.prototype.sendAsBinary)))&&!(safari&&/windows/i.test(userAgent)),cors=html5&&"withCredentials"in new XMLHttpRequest,chunked=html5&&!!Blob&&!!(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice),normalize=(""+"".normalize).indexOf("[native code]")>0,dataURLtoBlob=window.dataURLtoBlob,_rimg=/img/i,_rcanvas=/canvas/i,_rimgcanvas=/img|canvas/i,_rinput=/input/i,_rdata=/^data:[^,]+,/,_toString={}.toString,Math=window.Math,_SIZE_CONST=function(pow){pow=new window.Number(Math.pow(1024,pow));pow.from=function(sz){return Math.round(sz*this)};return pow},_elEvents={},_infoReader=[],_readerEvents="abort progress error load loadend",_xhrPropsExport="status statusText readyState response responseXML responseText responseBody".split(" "),currentTarget="currentTarget",preventDefault="preventDefault",_isArray=function(ar){return ar&&"length"in ar},_each=function(obj,fn,ctx){if(obj){if(_isArray(obj)){for(var i=0,n=obj.length;i<n;i++){if(i in obj){fn.call(ctx,obj[i],i,obj)}}}else{for(var key in obj){if(obj.hasOwnProperty(key)){fn.call(ctx,obj[key],key,obj)}}}}},_extend=function(dst){var args=arguments,i=1,_ext=function(val,key){dst[key]=val};for(;i<args.length;i++){_each(args[i],_ext)}return dst},_on=function(el,type,fn){if(el){var uid=api.uid(el);if(!_elEvents[uid]){_elEvents[uid]={}}var isFileReader=FileReader&&el&&el instanceof FileReader;_each(type.split(/\s+/),function(type){if(jQuery&&!isFileReader){jQuery.event.add(el,type,fn)}else{if(!_elEvents[uid][type]){_elEvents[uid][type]=[]}_elEvents[uid][type].push(fn);if(el.addEventListener){el.addEventListener(type,fn,false)}else if(el.attachEvent){el.attachEvent("on"+type,fn)}else{el["on"+type]=fn}}})}},_off=function(el,type,fn){if(el){var uid=api.uid(el),events=_elEvents[uid]||{};var isFileReader=FileReader&&el&&el instanceof FileReader;_each(type.split(/\s+/),function(type){if(jQuery&&!isFileReader){jQuery.event.remove(el,type,fn)}else{var fns=events[type]||[],i=fns.length;while(i--){if(fns[i]===fn){fns.splice(i,1);break}}if(el.addEventListener){el.removeEventListener(type,fn,false)}else if(el.detachEvent){el.detachEvent("on"+type,fn)}else{el["on"+type]=null}}})}},_one=function(el,type,fn){_on(el,type,function _(evt){_off(el,type,_);fn(evt)})},_fixEvent=function(evt){if(!evt.target){evt.target=window.event&&window.event.srcElement||document}if(evt.target.nodeType===3){evt.target=evt.target.parentNode}return evt},_supportInputAttr=function(attr){var input=document.createElement("input");input.setAttribute("type","file");return attr in input},api={version:"2.0.11",cors:false,html5:true,media:false,formData:true,multiPassResize:true,debug:false,pingUrl:false,multiFlash:false,flashAbortTimeout:0,withCredentials:true,staticPath:"./dist/",flashUrl:0,flashImageUrl:0,postNameConcat:function(name,idx){return name+(idx!=null?"["+idx+"]":"")},ext2mime:{jpg:"image/jpeg",tif:"image/tiff",txt:"text/plain"},accept:{"image/*":"art bm bmp dwg dxf cbr cbz fif fpx gif ico iefs jfif jpe jpeg jpg jps jut mcf nap nif pbm pcx pgm pict pm png pnm qif qtif ras rast rf rp svf tga tif tiff xbm xbm xpm xwd","audio/*":"m4a flac aac rm mpa wav wma ogg mp3 mp2 m3u mod amf dmf dsm far gdm imf it m15 med okt s3m stm sfx ult uni xm sid ac3 dts cue aif aiff wpl ape mac mpc mpp shn wv nsf spc gym adplug adx dsp adp ymf ast afc hps xs","video/*":"m4v 3gp nsv ts ty strm rm rmvb m3u ifo mov qt divx xvid bivx vob nrg img iso pva wmv asf asx ogm m2v avi bin dat dvr-ms mpg mpeg mp4 mkv avc vp3 svq3 nuv viv dv fli flv wpl"},uploadRetry:0,networkDownRetryTimeout:5e3,chunkSize:0,chunkUploadRetry:0,chunkNetworkDownRetryTimeout:2e3,KB:_SIZE_CONST(1),MB:_SIZE_CONST(2),GB:_SIZE_CONST(3),TB:_SIZE_CONST(4),EMPTY_PNG:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2NkAAIAAAoAAggA9GkAAAAASUVORK5CYII=",expando:"fileapi"+(new Date).getTime(),uid:function(obj){return obj?obj[api.expando]=obj[api.expando]||api.uid():(++gid,api.expando+gid)},log:function(){if(api.debug&&window.console&&console.log){if(console.log.apply){console.log.apply(console,arguments)}else{console.log([].join.call(arguments," "))}}},newImage:function(src,fn){var img=document.createElement("img");if(fn){api.event.one(img,"error load",function(evt){fn(evt.type=="error",img);img=null})}img.src=src;return img},getXHR:function(){var xhr;if(XMLHttpRequest){xhr=new XMLHttpRequest}else if(window.ActiveXObject){try{xhr=new ActiveXObject("MSXML2.XMLHttp.3.0")}catch(e){xhr=new ActiveXObject("Microsoft.XMLHTTP")}}return xhr},isArray:_isArray,support:{dnd:cors&&"ondrop"in document.createElement("div"),cors:cors,html5:html5,chunked:chunked,dataURI:true,accept:_supportInputAttr("accept"),multiple:_supportInputAttr("multiple")},event:{on:_on,off:_off,one:_one,fix:_fixEvent},throttle:function(fn,delay){var id,args;return function _throttle(){args=arguments;if(!id){fn.apply(window,args);id=setTimeout(function(){id=0;fn.apply(window,args)},delay)}}},F:function(){},parseJSON:function(str){var json;if(window.JSON&&JSON.parse){json=JSON.parse(str)}else{json=new Function("return ("+str.replace(/([\r\n])/g,"\\$1")+");")()}return json},trim:function(str){str=String(str);return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")},defer:function(){var list=[],result,error,defer={resolve:function(err,res){defer.resolve=noop;error=err||false;result=res;while(res=list.shift()){res(error,result)}},then:function(fn){if(error!==undef){fn(error,result)}else{list.push(fn)}}};return defer},queue:function(fn){var _idx=0,_length=0,_fail=false,_end=false,queue={inc:function(){_length++},next:function(){_idx++;setTimeout(queue.check,0)},check:function(){_idx>=_length&&!_fail&&queue.end()},isFail:function(){return _fail},fail:function(){!_fail&&fn(_fail=true)},end:function(){if(!_end){_end=true;fn()}}};return queue},each:_each,afor:function(array,callback){var i=0,n=array.length;if(_isArray(array)&&n--){(function _next(){callback(n!=i&&_next,array[i],i++)})()}else{callback(false)}},extend:_extend,isFile:function(file){return _toString.call(file)==="[object File]"},isBlob:function(blob){return this.isFile(blob)||_toString.call(blob)==="[object Blob]"},isCanvas:function(el){return el&&_rcanvas.test(el.nodeName)},getFilesFilter:function(filter){filter=typeof filter=="string"?filter:filter.getAttribute&&filter.getAttribute("accept")||"";return filter?new RegExp("("+filter.replace(/\./g,"\\.").replace(/,/g,"|")+")$","i"):/./},readAsDataURL:function(file,fn){if(api.isCanvas(file)){_emit(file,fn,"load",api.toDataURL(file))}else{_readAs(file,fn,"DataURL")}},readAsBinaryString:function(file,fn){if(_hasSupportReadAs("BinaryString")){_readAs(file,fn,"BinaryString")}else{_readAs(file,function(evt){if(evt.type=="load"){try{evt.result=api.toBinaryString(evt.result)}catch(e){evt.type="error";evt.message=e.toString()}}fn(evt)},"DataURL")}},readAsArrayBuffer:function(file,fn){_readAs(file,fn,"ArrayBuffer")},readAsText:function(file,encoding,fn){if(!fn){fn=encoding;encoding="utf-8"}_readAs(file,fn,"Text",encoding)},toDataURL:function(el,type){if(typeof el=="string"){return el}else if(el.toDataURL){return el.toDataURL(type||"image/png")}},toBinaryString:function(val){return window.atob(api.toDataURL(val).replace(_rdata,""))},readAsImage:function(file,fn,progress){if(api.isFile(file)){if(apiURL){var data=apiURL.createObjectURL(file);if(data===undef){_emit(file,fn,"error")}else{api.readAsImage(data,fn,progress)}}else{api.readAsDataURL(file,function(evt){if(evt.type=="load"){api.readAsImage(evt.result,fn,progress)}else if(progress||evt.type=="error"){_emit(file,fn,evt,null,{loaded:evt.loaded,total:evt.total})}})}}else if(api.isCanvas(file)){_emit(file,fn,"load",file)}else if(_rimg.test(file.nodeName)){if(file.complete){_emit(file,fn,"load",file)}else{var events="error abort load";_one(file,events,function _fn(evt){if(evt.type=="load"&&apiURL){apiURL.revokeObjectURL(file.src)}_off(file,events,_fn);_emit(file,fn,evt,file)})}}else if(file.iframe){_emit(file,fn,{type:"error"})}else{var img=api.newImage(file.dataURL||file);api.readAsImage(img,fn,progress)}},checkFileObj:function(name){var file={},accept=api.accept;if(typeof name=="object"){file=name}else{file.name=(name+"").split(/\\|\//g).pop()}if(file.type==null){file.type=file.name.split(".").pop()}_each(accept,function(ext,type){ext=new RegExp(ext.replace(/\s/g,"|"),"i");if(ext.test(file.type)||api.ext2mime[file.type]){file.type=api.ext2mime[file.type]||type.split("/")[0]+"/"+file.type}});return file},getDropFiles:function(evt,callback){var files=[],all=[],items,dataTransfer=_getDataTransfer(evt),transFiles=dataTransfer.files,transItems=dataTransfer.items,entrySupport=_isArray(transItems)&&transItems[0]&&_getAsEntry(transItems[0]),queue=api.queue(function(){callback(files,all)});if(entrySupport){if(normalize&&transFiles){var i=transFiles.length,file,entry;items=new Array(i);while(i--){file=transFiles[i];try{entry=_getAsEntry(transItems[i])}catch(err){api.log("[err] getDropFiles: ",err);entry=null}if(_isEntry(entry)){if(entry.isDirectory||entry.isFile&&file.name==file.name.normalize("NFC")){items[i]=entry}else{items[i]=file}}else{items[i]=file}}}else{items=transItems}}else{items=transFiles}_each(items||[],function(item){queue.inc();try{if(entrySupport&&_isEntry(item)){_readEntryAsFiles(item,function(err,entryFiles,allEntries){if(err){api.log("[err] getDropFiles:",err)}else{files.push.apply(files,entryFiles)}all.push.apply(all,allEntries);queue.next()})}else{_isRegularFile(item,function(yes,err){if(yes){files.push(item)}else{item.error=err}all.push(item);queue.next()})}}catch(err){queue.next();api.log("[err] getDropFiles: ",err)}});queue.check()},getFiles:function(input,filter,callback){var files=[];if(callback){api.filterFiles(api.getFiles(input),filter,callback);return null}if(input.jquery){input.each(function(){files=files.concat(api.getFiles(this))});input=files;files=[]}if(typeof filter=="string"){filter=api.getFilesFilter(filter)}if(input.originalEvent){input=_fixEvent(input.originalEvent)}else if(input.srcElement){input=_fixEvent(input)}if(input.dataTransfer){input=input.dataTransfer}else if(input.target){input=input.target}if(input.files){files=input.files;if(!html5){files[0].blob=input;files[0].iframe=true}}else if(!html5&&isInputFile(input)){if(api.trim(input.value)){files=[api.checkFileObj(input.value)];files[0].blob=input;files[0].iframe=true}}else if(_isArray(input)){files=input}return api.filter(files,function(file){return!filter||filter.test(file.name)})},getTotalSize:function(files){var size=0,i=files&&files.length;while(i--){size+=files[i].size}return size},getInfo:function(file,fn){var info={},readers=_infoReader.concat();if(api.isFile(file)){(function _next(){var reader=readers.shift();if(reader){if(reader.test(file.type)){reader(file,function(err,res){if(err){fn(err)}else{_extend(info,res);_next()}})}else{_next()}}else{fn(false,info)}})()}else{fn("not_support_info",info)}},addInfoReader:function(mime,fn){fn.test=function(type){return mime.test(type)};_infoReader.push(fn)},filter:function(input,fn){var result=[],i=0,n=input.length,val;for(;i<n;i++){if(i in input){val=input[i];if(fn.call(val,val,i,input)){result.push(val)}}}return result},filterFiles:function(files,eachFn,resultFn){if(files.length){var queue=files.concat(),file,result=[],deleted=[];(function _next(){if(queue.length){file=queue.shift();api.getInfo(file,function(err,info){(eachFn(file,err?false:info)?result:deleted).push(file);_next()})}else{resultFn(result,deleted)}})()}else{resultFn([],files)}},upload:function(options){options=_extend({jsonp:"callback",prepare:api.F,beforeupload:api.F,upload:api.F,fileupload:api.F,fileprogress:api.F,filecomplete:api.F,progress:api.F,complete:api.F,pause:api.F,imageOriginal:true,chunkSize:api.chunkSize,chunkUploadRetry:api.chunkUploadRetry,uploadRetry:api.uploadRetry},options);if(options.imageAutoOrientation&&!options.imageTransform){options.imageTransform={rotate:"auto"}}var proxyXHR=new api.XHR(options),dataArray=this._getFilesDataArray(options.files),_this=this,_total=0,_loaded=0,_nextFile,_complete=false;_each(dataArray,function(data){_total+=data.size});proxyXHR.files=[];_each(dataArray,function(data){proxyXHR.files.push(data.file)});proxyXHR.total=_total;proxyXHR.loaded=0;proxyXHR.filesLeft=dataArray.length;options.beforeupload(proxyXHR,options);_nextFile=function(){var data=dataArray.shift(),_file=data&&data.file,_fileLoaded=false,_fileOptions=_simpleClone(options);proxyXHR.filesLeft=dataArray.length;if(_file&&_file.name===api.expando){_file=null;api.log("[warn] FileAPI.upload() — called without files")}if((proxyXHR.statusText!="abort"||proxyXHR.current)&&data){_complete=false;proxyXHR.currentFile=_file;if(_file&&options.prepare(_file,_fileOptions)===false){_nextFile.call(_this);return}_fileOptions.file=_file;_this._getFormData(_fileOptions,data,function(form){if(!_loaded){options.upload(proxyXHR,options)}var xhr=new api.XHR(_extend({},_fileOptions,{upload:_file?function(){options.fileupload(_file,xhr,_fileOptions)}:noop,progress:_file?function(evt){if(!_fileLoaded){_fileLoaded=evt.loaded===evt.total;options.fileprogress({type:"progress",total:data.total=evt.total,loaded:data.loaded=evt.loaded},_file,xhr,_fileOptions);options.progress({type:"progress",total:_total,loaded:proxyXHR.loaded=_loaded+data.size*(evt.loaded/evt.total)||0},_file,xhr,_fileOptions)}}:noop,complete:function(err){_each(_xhrPropsExport,function(name){proxyXHR[name]=xhr[name]});if(_file){data.total=data.total||data.size;data.loaded=data.total;if(!err){this.progress(data);_fileLoaded=true;_loaded+=data.size;proxyXHR.loaded=_loaded}options.filecomplete(err,xhr,_file,_fileOptions)}setTimeout(function(){_nextFile.call(_this)},0)}}));proxyXHR.abort=function(current){if(!current){dataArray.length=0}this.current=current;xhr.abort()};xhr.send(form)})}else{var successful=proxyXHR.status==200||proxyXHR.status==201||proxyXHR.status==204;options.complete(successful?false:proxyXHR.statusText||"error",proxyXHR,options);_complete=true}};setTimeout(_nextFile,0);proxyXHR.append=function(files,first){files=api._getFilesDataArray([].concat(files));_each(files,function(data){_total+=data.size;proxyXHR.files.push(data.file);if(first){dataArray.unshift(data)}else{dataArray.push(data)}});proxyXHR.statusText="";if(_complete){_nextFile.call(_this)}};proxyXHR.remove=function(file){var i=dataArray.length,_file;while(i--){if(dataArray[i].file==file){_file=dataArray.splice(i,1);_total-=_file.size}}return _file};return proxyXHR},_getFilesDataArray:function(data){var files=[],oFiles={};if(isInputFile(data)){var tmp=api.getFiles(data);oFiles[data.name||"file"]=data.getAttribute("multiple")!==null?tmp:tmp[0]}else if(_isArray(data)&&isInputFile(data[0])){_each(data,function(input){oFiles[input.name||"file"]=api.getFiles(input)})}else{oFiles=data}_each(oFiles,function add(file,name){if(_isArray(file)){_each(file,function(file){add(file,name)})}else if(file&&(file.name||file.image)){files.push({name:name,file:file,size:file.size,total:file.size,loaded:0})}});if(!files.length){files.push({file:{name:api.expando}})}return files},_getFormData:function(options,data,fn){var file=data.file,name=data.name,filename=file.name,filetype=file.type,trans=api.support.transform&&options.imageTransform,Form=new api.Form,queue=api.queue(function(){fn(Form)}),isOrignTrans=trans&&_isOriginTransform(trans),postNameConcat=api.postNameConcat;_each(options.data,function add(val,name){if(typeof val=="object"){_each(val,function(v,i){add(v,postNameConcat(name,i))})}else{Form.append(name,val)}});(function _addFile(file){if(file.image){queue.inc();file.toData(function(err,image){filename=filename||(new Date).getTime()+".png";_addFile(image);queue.next()})}else if(api.Image&&trans&&(/^image/.test(file.type)||_rimgcanvas.test(file.nodeName))){queue.inc();if(isOrignTrans){trans=[trans]}api.Image.transform(file,trans,options.imageAutoOrientation,function(err,images){if(isOrignTrans&&!err){if(!dataURLtoBlob&&!api.flashEngine){Form.multipart=true}Form.append(name,images[0],filename,trans[0].type||filetype)}else{var addOrigin=0;if(!err){_each(images,function(image,idx){if(!dataURLtoBlob&&!api.flashEngine){Form.multipart=true}if(!trans[idx].postName){addOrigin=1}Form.append(trans[idx].postName||postNameConcat(name,idx),image,filename,trans[idx].type||filetype)})}if(err||options.imageOriginal){Form.append(postNameConcat(name,addOrigin?"original":null),file,filename,filetype)}}queue.next()})}else if(filename!==api.expando){Form.append(name,file,filename)}})(file);queue.check()},reset:function(inp,notRemove){var parent,clone;if(jQuery){clone=jQuery(inp).clone(true).insertBefore(inp).val("")[0];if(!notRemove){jQuery(inp).remove()}}else{parent=inp.parentNode;clone=parent.insertBefore(inp.cloneNode(true),inp);clone.value="";if(!notRemove){parent.removeChild(inp)}_each(_elEvents[api.uid(inp)],function(fns,type){_each(fns,function(fn){_off(inp,type,fn);_on(clone,type,fn)})})}return clone},load:function(url,fn){var xhr=api.getXHR();if(xhr){xhr.open("GET",url,true);if(xhr.overrideMimeType){xhr.overrideMimeType("text/plain; charset=x-user-defined")}_on(xhr,"progress",function(evt){if(evt.lengthComputable){fn({type:evt.type,loaded:evt.loaded,total:evt.total},xhr)}});xhr.onreadystatechange=function(){if(xhr.readyState==4){xhr.onreadystatechange=null;if(xhr.status==200){url=url.split("/");var file={name:url[url.length-1],size:xhr.getResponseHeader("Content-Length"),type:xhr.getResponseHeader("Content-Type")};file.dataURL="data:"+file.type+";base64,"+api.encode64(xhr.responseBody||xhr.responseText);fn({type:"load",result:file},xhr)}else{fn({type:"error"},xhr)}}};xhr.send(null)}else{fn({type:"error"})}return xhr},encode64:function(str){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",outStr="",i=0;if(typeof str!=="string"){str=String(str)}while(i<str.length){var byte1=str.charCodeAt(i++)&255,byte2=str.charCodeAt(i++)&255,byte3=str.charCodeAt(i++)&255,enc1=byte1>>2,enc2=(byte1&3)<<4|byte2>>4,enc3,enc4;if(isNaN(byte2)){enc3=enc4=64}else{enc3=(byte2&15)<<2|byte3>>6;enc4=isNaN(byte3)?64:byte3&63}outStr+=b64.charAt(enc1)+b64.charAt(enc2)+b64.charAt(enc3)+b64.charAt(enc4)}return outStr}};function _emit(target,fn,name,res,ext){var evt={type:name.type||name,target:target,result:res};_extend(evt,ext);fn(evt)}function _hasSupportReadAs(method){return FileReader&&!!FileReader.prototype["readAs"+method]}function _readAs(file,fn,method,encoding){if(api.isBlob(file)&&_hasSupportReadAs(method)){var Reader=new FileReader;_on(Reader,_readerEvents,function _fn(evt){var type=evt.type;if(type=="progress"){_emit(file,fn,evt,evt.target.result,{loaded:evt.loaded,total:evt.total})}else if(type=="loadend"){_off(Reader,_readerEvents,_fn);Reader=null}else{_emit(file,fn,evt,evt.target.result)}});try{if(encoding){Reader["readAs"+method](file,encoding)}else{Reader["readAs"+method](file)}}catch(err){_emit(file,fn,"error",undef,{error:err.toString()})}}else{_emit(file,fn,"error",undef,{error:"filreader_not_support_"+method})}}function _isRegularFile(file,callback){if(!file.type&&(safari||file.size%4096===0&&file.size<=102400)){if(FileReader){try{var reader=new FileReader;_one(reader,_readerEvents,function(evt){var isFile=evt.type!="error";if(isFile){reader.abort();callback(isFile)}else{callback(false,reader.error)}});reader.readAsDataURL(file)}catch(err){callback(false,err)}}else{callback(null,new Error("FileReader is not supported"))}}else{callback(true)}}function _isEntry(item){return item&&(item.isFile||item.isDirectory)}function _getAsEntry(item){var entry;if(item.getAsEntry){entry=item.getAsEntry()}else if(item.webkitGetAsEntry){entry=item.webkitGetAsEntry()}return entry}function _readEntryAsFiles(entry,callback){if(!entry){var err=new Error("invalid entry");entry=new Object(entry);entry.error=err;callback(err.message,[],[entry])}else if(entry.isFile){entry.file(function(file){file.fullPath=entry.fullPath;callback(false,[file],[file])},function(err){entry.error=err;callback("FileError.code: "+err.code,[],[entry])})}else if(entry.isDirectory){var reader=entry.createReader(),firstAttempt=true,files=[],all=[entry];var onerror=function(err){entry.error=err;callback("DirectoryError.code: "+err.code,files,all)};var ondone=function ondone(entries){if(firstAttempt){firstAttempt=false;if(!entries.length){entry.error=new Error("directory is empty")}}if(entries.length){api.afor(entries,function(next,entry){_readEntryAsFiles(entry,function(err,entryFiles,allEntries){if(!err){files=files.concat(entryFiles)}all=all.concat(allEntries);if(next){next()}else{reader.readEntries(ondone,onerror)}})})}else{callback(false,files,all)}};reader.readEntries(ondone,onerror)}else{_readEntryAsFiles(_getAsEntry(entry),callback)}}function _simpleClone(obj){var copy={};_each(obj,function(val,key){if(val&&typeof val==="object"&&val.nodeType===void 0){val=_extend({},val)}copy[key]=val});return copy}function isInputFile(el){return _rinput.test(el&&el.tagName)}function _getDataTransfer(evt){return(evt.originalEvent||evt||"").dataTransfer||{}}function _isOriginTransform(trans){var key;for(key in trans){if(trans.hasOwnProperty(key)){if(!(trans[key]instanceof Object||key==="overlay"||key==="filter")){return true}}}return false}api.addInfoReader(/^image/,function(file,callback){if(!file.__dimensions){var defer=file.__dimensions=api.defer();api.readAsImage(file,function(evt){var img=evt.target;defer.resolve(evt.type=="load"?false:"error",{width:img.width,height:img.height});img.src=api.EMPTY_PNG;img=null})}file.__dimensions.then(callback)});api.event.dnd=function(el,onHover,onDrop){var _id,_type;if(!onDrop){onDrop=onHover;onHover=api.F}if(FileReader){_on(el,"dragenter dragleave dragover",onHover.ff=onHover.ff||function(evt){var types=_getDataTransfer(evt).types,i=types&&types.length,debounceTrigger=false;while(i--){if(~types[i].indexOf("File")){evt[preventDefault]();if(_type!==evt.type){_type=evt.type;if(_type!="dragleave"){onHover.call(evt[currentTarget],true,evt)}debounceTrigger=true}break}}if(debounceTrigger){clearTimeout(_id);_id=setTimeout(function(){onHover.call(evt[currentTarget],_type!="dragleave",evt)},50)}});_on(el,"drop",onDrop.ff=onDrop.ff||function(evt){evt[preventDefault]();_type=0;onHover.call(evt[currentTarget],false,evt);api.getDropFiles(evt,function(files,all){onDrop.call(evt[currentTarget],files,all,evt)})})}else{api.log("Drag'n'Drop -- not supported")}};api.event.dnd.off=function(el,onHover,onDrop){_off(el,"dragenter dragleave dragover",onHover.ff);_off(el,"drop",onDrop.ff)};if(jQuery&&!jQuery.fn.dnd){jQuery.fn.dnd=function(onHover,onDrop){return this.each(function(){api.event.dnd(this,onHover,onDrop)})};jQuery.fn.offdnd=function(onHover,onDrop){return this.each(function(){api.event.dnd.off(this,onHover,onDrop)})}}window.FileAPI=_extend(api,window.FileAPI);api.log("FileAPI: "+api.version);api.log("protocol: "+window.location.protocol);api.log("doctype: ["+doctype.name+"] "+doctype.publicId+" "+doctype.systemId);_each(document.getElementsByTagName("meta"),function(meta){if(/x-ua-compatible/i.test(meta.getAttribute("http-equiv"))){api.log("meta.http-equiv: "+meta.getAttribute("content"))}});if(!api.flashUrl){api.flashUrl=api.staticPath+"FileAPI.flash.swf"}if(!api.flashImageUrl){api.flashImageUrl=api.staticPath+"FileAPI.flash.image.swf"}if(!api.flashWebcamUrl){api.flashWebcamUrl=api.staticPath+"FileAPI.flash.camera.swf"}})(window,void 0);(function(api,document,undef){"use strict";var min=Math.min,round=Math.round,getCanvas=function(){return document.createElement("canvas")},support=false,exifOrientation={8:270,3:180,6:90,7:270,4:180,5:90};try{support=getCanvas().toDataURL("image/png").indexOf("data:image/png")>-1}catch(e){}function Image(file){if(file instanceof Image){var img=new Image(file.file);api.extend(img.matrix,file.matrix);return img}else if(!(this instanceof Image)){return new Image(file)}this.file=file;this.size=file.size||100;this.matrix={sx:0,sy:0,sw:0,sh:0,dx:0,dy:0,dw:0,dh:0,resize:0,deg:0,quality:1,filter:0}}Image.prototype={image:true,constructor:Image,set:function(attrs){api.extend(this.matrix,attrs);return this},crop:function(x,y,w,h){if(w===undef){w=x;h=y;x=y=0}return this.set({sx:x,sy:y,sw:w,sh:h||w})},resize:function(w,h,strategy){if(/min|max|height|width/.test(h)){strategy=h;h=w}return this.set({dw:w,dh:h||w,resize:strategy})},preview:function(w,h){return this.resize(w,h||w,"preview")},rotate:function(deg){return this.set({deg:deg})},filter:function(filter){return this.set({filter:filter})},overlay:function(images){return this.set({overlay:images})},clone:function(){return new Image(this)},_load:function(image,fn){var self=this;if(/img|video/i.test(image.nodeName)){fn.call(self,null,image)}else{api.readAsImage(image,function(evt){fn.call(self,evt.type!="load",evt.result)})}},_apply:function(image,fn){var canvas=getCanvas(),m=this.getMatrix(image),ctx=canvas.getContext("2d"),width=image.videoWidth||image.width,height=image.videoHeight||image.height,deg=m.deg,dw=m.dw,dh=m.dh,w=width,h=height,filter=m.filter,copy,buffer=image,overlay=m.overlay,queue=api.queue(function(){image.src=api.EMPTY_PNG;fn(false,canvas)}),renderImageToCanvas=api.renderImageToCanvas;deg=deg-Math.floor(deg/360)*360;image._type=this.file.type;while(m.multipass&&min(w/dw,h/dh)>2){w=w/2+.5|0;h=h/2+.5|0;copy=getCanvas();copy.width=w;copy.height=h;if(buffer!==image){renderImageToCanvas(copy,buffer,0,0,buffer.width,buffer.height,0,0,w,h);buffer=copy}else{buffer=copy;renderImageToCanvas(buffer,image,m.sx,m.sy,m.sw,m.sh,0,0,w,h);m.sx=m.sy=m.sw=m.sh=0}}canvas.width=deg%180?dh:dw;canvas.height=deg%180?dw:dh;canvas.type=m.type;canvas.quality=m.quality;ctx.rotate(deg*Math.PI/180);renderImageToCanvas(ctx.canvas,buffer,m.sx,m.sy,m.sw||buffer.width,m.sh||buffer.height,deg==180||deg==270?-dw:0,deg==90||deg==180?-dh:0,dw,dh);dw=canvas.width;dh=canvas.height;overlay&&api.each([].concat(overlay),function(over){queue.inc();var img=new window.Image,fn=function(){var x=over.x|0,y=over.y|0,w=over.w||img.width,h=over.h||img.height,rel=over.rel;x=rel==1||rel==4||rel==7?(dw-w+x)/2:rel==2||rel==5||rel==8?dw-(w+x):x;y=rel==3||rel==4||rel==5?(dh-h+y)/2:rel>=6?dh-(h+y):y;api.event.off(img,"error load abort",fn);try{ctx.globalAlpha=over.opacity||1;ctx.drawImage(img,x,y,w,h)}catch(er){}queue.next()};api.event.on(img,"error load abort",fn);img.src=over.src;if(img.complete){fn()}});if(filter){queue.inc();Image.applyFilter(canvas,filter,queue.next)}queue.check()},getMatrix:function(image){var m=api.extend({},this.matrix),sw=m.sw=m.sw||image.videoWidth||image.naturalWidth||image.width,sh=m.sh=m.sh||image.videoHeight||image.naturalHeight||image.height,dw=m.dw=m.dw||sw,dh=m.dh=m.dh||sh,sf=sw/sh,df=dw/dh,strategy=m.resize;if(strategy=="preview"){if(dw!=sw||dh!=sh){var w,h;if(df>=sf){w=sw;h=w/df}else{h=sh;w=h*df}if(w!=sw||h!=sh){m.sx=~~((sw-w)/2);m.sy=~~((sh-h)/2);sw=w;sh=h}}}else if(strategy=="height"){dw=dh*sf}else if(strategy=="width"){dh=dw/sf}else if(strategy){if(!(sw>dw||sh>dh)){dw=sw;dh=sh}else if(strategy=="min"){dw=round(sf<df?min(sw,dw):dh*sf);dh=round(sf<df?dw/sf:min(sh,dh))}else{dw=round(sf>=df?min(sw,dw):dh*sf);dh=round(sf>=df?dw/sf:min(sh,dh))}}m.sw=sw;m.sh=sh;m.dw=dw;m.dh=dh;m.multipass=api.multiPassResize;return m},_trans:function(fn){this._load(this.file,function(err,image){if(err){fn(err)}else{try{this._apply(image,fn)}catch(err){api.log("[err] FileAPI.Image.fn._apply:",err);fn(err)}}})},get:function(fn){if(api.support.transform){var _this=this,matrix=_this.matrix;if(matrix.deg=="auto"){api.getInfo(_this.file,function(err,info){matrix.deg=exifOrientation[info&&info.exif&&info.exif.Orientation]||0;_this._trans(fn)})}else{_this._trans(fn)}}else{fn("not_support_transform")}return this},toData:function(fn){return this.get(fn)}};Image.exifOrientation=exifOrientation;Image.transform=function(file,transform,autoOrientation,fn){function _transform(err,img){var images={},queue=api.queue(function(err){fn(err,images)});if(!err){api.each(transform,function(params,name){if(!queue.isFail()){var ImgTrans=new Image(img.nodeType?img:file),isFn=typeof params=="function";if(isFn){params(img,ImgTrans)}else if(params.width){ImgTrans[params.preview?"preview":"resize"](params.width,params.height,params.strategy)}else{if(params.maxWidth&&(img.width>params.maxWidth||img.height>params.maxHeight)){ImgTrans.resize(params.maxWidth,params.maxHeight,"max")}}if(params.crop){var crop=params.crop;ImgTrans.crop(crop.x|0,crop.y|0,crop.w||crop.width,crop.h||crop.height)}if(params.rotate===undef&&autoOrientation){params.rotate="auto"}ImgTrans.set({type:ImgTrans.matrix.type||params.type||file.type||"image/png"});if(!isFn){ImgTrans.set({deg:params.rotate,overlay:params.overlay,filter:params.filter,quality:params.quality||1})}queue.inc();ImgTrans.toData(function(err,image){if(err){queue.fail()}else{images[name]=image;queue.next()}})}})}else{queue.fail()}}if(file.width){_transform(false,file)}else{api.getInfo(file,_transform)}};api.each(["TOP","CENTER","BOTTOM"],function(x,i){api.each(["LEFT","CENTER","RIGHT"],function(y,j){Image[x+"_"+y]=i*3+j;Image[y+"_"+x]=i*3+j})});Image.toCanvas=function(el){var canvas=document.createElement("canvas");canvas.width=el.videoWidth||el.width;canvas.height=el.videoHeight||el.height;canvas.getContext("2d").drawImage(el,0,0);return canvas};Image.fromDataURL=function(dataURL,size,callback){var img=api.newImage(dataURL);api.extend(img,size);callback(img)};Image.applyFilter=function(canvas,filter,doneFn){if(typeof filter=="function"){filter(canvas,doneFn)}else if(window.Caman){window.Caman(canvas.tagName=="IMG"?Image.toCanvas(canvas):canvas,function(){if(typeof filter=="string"){this[filter]()}else{api.each(filter,function(val,method){this[method](val)},this)}this.render(doneFn)})}};api.renderImageToCanvas=function(canvas,img,sx,sy,sw,sh,dx,dy,dw,dh){try{return canvas.getContext("2d").drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh);
}catch(ex){api.log("renderImageToCanvas failed");throw ex}};api.support.canvas=api.support.transform=support;api.Image=Image})(FileAPI,document);(function(factory){"use strict";factory(FileAPI)})(function(loadImage){"use strict";if(!window.navigator||!window.navigator.platform||!/iP(hone|od|ad)/.test(window.navigator.platform)){return}var originalRenderMethod=loadImage.renderImageToCanvas;loadImage.detectSubsampling=function(img){var canvas,context;if(img.width*img.height>1024*1024){canvas=document.createElement("canvas");canvas.width=canvas.height=1;context=canvas.getContext("2d");context.drawImage(img,-img.width+1,0);return context.getImageData(0,0,1,1).data[3]===0}return false};loadImage.detectVerticalSquash=function(img,subsampled){var naturalHeight=img.naturalHeight||img.height,canvas=document.createElement("canvas"),context=canvas.getContext("2d"),data,sy,ey,py,alpha;if(subsampled){naturalHeight/=2}canvas.width=1;canvas.height=naturalHeight;context.drawImage(img,0,0);data=context.getImageData(0,0,1,naturalHeight).data;sy=0;ey=naturalHeight;py=naturalHeight;while(py>sy){alpha=data[(py-1)*4+3];if(alpha===0){ey=py}else{sy=py}py=ey+sy>>1}return py/naturalHeight||1};loadImage.renderImageToCanvas=function(canvas,img,sourceX,sourceY,sourceWidth,sourceHeight,destX,destY,destWidth,destHeight){if(img._type==="image/jpeg"){var context=canvas.getContext("2d"),tmpCanvas=document.createElement("canvas"),tileSize=1024,tmpContext=tmpCanvas.getContext("2d"),subsampled,vertSquashRatio,tileX,tileY;tmpCanvas.width=tileSize;tmpCanvas.height=tileSize;context.save();subsampled=loadImage.detectSubsampling(img);if(subsampled){sourceX/=2;sourceY/=2;sourceWidth/=2;sourceHeight/=2}vertSquashRatio=loadImage.detectVerticalSquash(img,subsampled);if(subsampled||vertSquashRatio!==1){sourceY*=vertSquashRatio;destWidth=Math.ceil(tileSize*destWidth/sourceWidth);destHeight=Math.ceil(tileSize*destHeight/sourceHeight/vertSquashRatio);destY=0;tileY=0;while(tileY<sourceHeight){destX=0;tileX=0;while(tileX<sourceWidth){tmpContext.clearRect(0,0,tileSize,tileSize);tmpContext.drawImage(img,sourceX,sourceY,sourceWidth,sourceHeight,-tileX,-tileY,sourceWidth,sourceHeight);context.drawImage(tmpCanvas,0,0,tileSize,tileSize,destX,destY,destWidth,destHeight);tileX+=tileSize;destX+=destWidth}tileY+=tileSize;destY+=destHeight}context.restore();return canvas}}return originalRenderMethod(canvas,img,sourceX,sourceY,sourceWidth,sourceHeight,destX,destY,destWidth,destHeight)}});(function(api,window){"use strict";var document=window.document,FormData=window.FormData,Form=function(){this.items=[]},encodeURIComponent=window.encodeURIComponent;Form.prototype={append:function(name,blob,file,type){this.items.push({name:name,blob:blob&&blob.blob||(blob==void 0?"":blob),file:blob&&(file||blob.name),type:blob&&(type||blob.type)})},each:function(fn){var i=0,n=this.items.length;for(;i<n;i++){fn.call(this,this.items[i])}},toData:function(fn,options){options._chunked=api.support.chunked&&options.chunkSize>0&&api.filter(this.items,function(item){return item.file}).length==1;if(!api.support.html5){api.log("FileAPI.Form.toHtmlData");this.toHtmlData(fn)}else if(!api.formData||this.multipart||!FormData){api.log("FileAPI.Form.toMultipartData");this.toMultipartData(fn)}else if(options._chunked){api.log("FileAPI.Form.toPlainData");this.toPlainData(fn)}else{api.log("FileAPI.Form.toFormData");this.toFormData(fn)}},_to:function(data,complete,next,arg){var queue=api.queue(function(){complete(data)});this.each(function(file){try{next(file,data,queue,arg)}catch(err){api.log("FileAPI.Form._to: "+err.message);complete(err)}});queue.check()},toHtmlData:function(fn){this._to(document.createDocumentFragment(),fn,function(file,data){var blob=file.blob,hidden;if(file.file){api.reset(blob,true);blob.name=file.name;blob.disabled=false;data.appendChild(blob)}else{hidden=document.createElement("input");hidden.name=file.name;hidden.type="hidden";hidden.value=blob;data.appendChild(hidden)}})},toPlainData:function(fn){this._to({},fn,function(file,data,queue){if(file.file){data.type=file.file}if(file.blob.toBlob){queue.inc();_convertFile(file,function(file,blob){data.name=file.name;data.file=blob;data.size=blob.length;data.type=file.type;queue.next()})}else if(file.file){data.name=file.blob.name;data.file=file.blob;data.size=file.blob.size;data.type=file.type}else{if(!data.params){data.params=[]}data.params.push(encodeURIComponent(file.name)+"="+encodeURIComponent(file.blob))}data.start=-1;data.end=data.file&&data.file.FileAPIReadPosition||-1;data.retry=0})},toFormData:function(fn){this._to(new FormData,fn,function(file,data,queue){if(file.blob&&file.blob.toBlob){queue.inc();_convertFile(file,function(file,blob){data.append(file.name,blob,file.file);queue.next()})}else if(file.file){data.append(file.name,file.blob,file.file)}else{data.append(file.name,file.blob)}if(file.file){data.append("_"+file.name,file.file)}})},toMultipartData:function(fn){this._to([],fn,function(file,data,queue,boundary){queue.inc();_convertFile(file,function(file,blob){data.push("--_"+boundary+('\r\nContent-Disposition: form-data; name="'+file.name+'"'+(file.file?'; filename="'+encodeURIComponent(file.file)+'"':"")+(file.file?"\r\nContent-Type: "+(file.type||"application/octet-stream"):"")+"\r\n"+"\r\n"+(file.file?blob:encodeURIComponent(blob))+"\r\n"));queue.next()},true)},api.expando)}};function _convertFile(file,fn,useBinaryString){var blob=file.blob,filename=file.file;if(filename){if(!blob.toDataURL){api.readAsBinaryString(blob,function(evt){if(evt.type=="load"){fn(file,evt.result)}});return}var mime={"image/jpeg":".jpe?g","image/png":".png"},type=mime[file.type]?file.type:"image/png",ext=mime[type]||".png",quality=blob.quality||1;if(!filename.match(new RegExp(ext+"$","i"))){filename+=ext.replace("?","")}file.file=filename;file.type=type;if(!useBinaryString&&blob.toBlob){blob.toBlob(function(blob){fn(file,blob)},type,quality)}else{fn(file,api.toBinaryString(blob.toDataURL(type,quality)))}}else{fn(file,blob)}}api.Form=Form})(FileAPI,window);(function(window,api){"use strict";var noop=function(){},document=window.document,XHR=function(options){this.uid=api.uid();this.xhr={abort:noop,getResponseHeader:noop,getAllResponseHeaders:noop};this.options=options},_xhrResponsePostfix={"":1,XML:1,Text:1,Body:1};XHR.prototype={status:0,statusText:"",constructor:XHR,getResponseHeader:function(name){return this.xhr.getResponseHeader(name)},getAllResponseHeaders:function(){return this.xhr.getAllResponseHeaders()||{}},end:function(status,statusText){var _this=this,options=_this.options;_this.end=_this.abort=noop;_this.status=status;if(statusText){_this.statusText=statusText}api.log("xhr.end:",status,statusText);options.complete(status==200||status==201?false:_this.statusText||"unknown",_this);if(_this.xhr&&_this.xhr.node){setTimeout(function(){var node=_this.xhr.node;try{node.parentNode.removeChild(node)}catch(e){}try{delete window[_this.uid]}catch(e){}window[_this.uid]=_this.xhr.node=null},9)}},abort:function(){this.end(0,"abort");if(this.xhr){this.xhr.aborted=true;this.xhr.abort()}},send:function(FormData){var _this=this,options=this.options;FormData.toData(function(data){if(data instanceof Error){_this.end(0,data.message)}else{options.upload(options,_this);_this._send.call(_this,options,data)}},options)},_send:function(options,data){var _this=this,xhr,uid=_this.uid,onLoadFnName=_this.uid+"Load",url=options.url;api.log("XHR._send:",data);if(!options.cache){url+=(~url.indexOf("?")?"&":"?")+api.uid()}if(data.nodeName){var jsonp=options.jsonp;url=url.replace(/([a-z]+)=(\?)/i,"$1="+uid);options.upload(options,_this);var onPostMessage=function(evt){if(~url.indexOf(evt.origin)){try{var result=api.parseJSON(evt.data);if(result.id==uid){complete(result.status,result.statusText,result.response)}}catch(err){complete(0,err.message)}}},complete=window[uid]=function(status,statusText,response){_this.readyState=4;_this.responseText=response;_this.end(status,statusText);api.event.off(window,"message",onPostMessage);window[uid]=xhr=transport=window[onLoadFnName]=null};_this.xhr.abort=function(){try{if(transport.stop){transport.stop()}else if(transport.contentWindow.stop){transport.contentWindow.stop()}else{transport.contentWindow.document.execCommand("Stop")}}catch(er){}complete(0,"abort")};api.event.on(window,"message",onPostMessage);window[onLoadFnName]=function(){try{var win=transport.contentWindow,doc=win.document,result=win.result||api.parseJSON(doc.body.innerHTML);complete(result.status,result.statusText,result.response)}catch(e){api.log("[transport.onload]",e)}};xhr=document.createElement("div");xhr.innerHTML='<form target="'+uid+'" action="'+url+'" method="POST" enctype="multipart/form-data" style="position: absolute; top: -1000px; overflow: hidden; width: 1px; height: 1px;">'+'<iframe name="'+uid+'" src="javascript:false;" onload="window.'+onLoadFnName+" && "+onLoadFnName+'();"></iframe>'+(jsonp&&options.url.indexOf("=?")<0?'<input value="'+uid+'" name="'+jsonp+'" type="hidden"/>':"")+"</form>";var form=xhr.getElementsByTagName("form")[0],transport=xhr.getElementsByTagName("iframe")[0];form.appendChild(data);api.log(form.parentNode.innerHTML);document.body.appendChild(xhr);_this.xhr.node=xhr;_this.readyState=2;try{form.submit()}catch(err){api.log("iframe.error: "+err)}form=null}else{url=url.replace(/([a-z]+)=(\?)&?/i,"");if(this.xhr&&this.xhr.aborted){api.log("Error: already aborted");return}xhr=_this.xhr=api.getXHR();if(data.params){url+=(url.indexOf("?")<0?"?":"&")+data.params.join("&")}xhr.open("POST",url,true);if(api.withCredentials){xhr.withCredentials="true"}if(!options.headers||!options.headers["X-Requested-With"]){xhr.setRequestHeader("X-Requested-With","XMLHttpRequest")}api.each(options.headers,function(val,key){xhr.setRequestHeader(key,val)});if(options._chunked){if(xhr.upload){xhr.upload.addEventListener("progress",api.throttle(function(evt){if(!data.retry){options.progress({type:evt.type,total:data.size,loaded:data.start+evt.loaded,totalSize:data.size},_this,options)}},100),false)}xhr.onreadystatechange=function(){var lkb=parseInt(xhr.getResponseHeader("X-Last-Known-Byte"),10);_this.status=xhr.status;_this.statusText=xhr.statusText;_this.readyState=xhr.readyState;if(xhr.readyState==4){for(var k in _xhrResponsePostfix){_this["response"+k]=xhr["response"+k]}xhr.onreadystatechange=null;if(!xhr.status||xhr.status-201>0){api.log("Error: "+xhr.status);if((!xhr.status&&!xhr.aborted||500==xhr.status||416==xhr.status)&&++data.retry<=options.chunkUploadRetry){var delay=xhr.status?0:api.chunkNetworkDownRetryTimeout;options.pause(data.file,options);api.log("X-Last-Known-Byte: "+lkb);if(lkb){data.end=lkb}else{data.end=data.start-1;if(416==xhr.status){data.end=data.end-options.chunkSize}}setTimeout(function(){_this._send(options,data)},delay)}else{_this.end(xhr.status)}}else{data.retry=0;if(data.end==data.size-1){_this.end(xhr.status)}else{api.log("X-Last-Known-Byte: "+lkb);if(lkb){data.end=lkb}data.file.FileAPIReadPosition=data.end;setTimeout(function(){_this._send(options,data)},0)}}xhr=null}};data.start=data.end+1;data.end=Math.max(Math.min(data.start+options.chunkSize,data.size)-1,data.start);var file=data.file,slice=(file.slice||file.mozSlice||file.webkitSlice).call(file,data.start,data.end+1);if(data.size&&!slice.size){setTimeout(function(){_this.end(-1)})}else{xhr.setRequestHeader("Content-Range","bytes "+data.start+"-"+data.end+"/"+data.size);xhr.setRequestHeader("Content-Disposition","attachment; filename="+encodeURIComponent(data.name));xhr.setRequestHeader("Content-Type",data.type||"application/octet-stream");xhr.send(slice)}file=slice=null}else{if(xhr.upload){xhr.upload.addEventListener("progress",api.throttle(function(evt){options.progress(evt,_this,options)},100),false)}xhr.onreadystatechange=function(){_this.status=xhr.status;_this.statusText=xhr.statusText;_this.readyState=xhr.readyState;if(xhr.readyState==4){for(var k in _xhrResponsePostfix){_this["response"+k]=xhr["response"+k]}xhr.onreadystatechange=null;if(!xhr.status||xhr.status>201){api.log("Error: "+xhr.status);if((!xhr.status&&!xhr.aborted||500==xhr.status)&&(options.retry||0)<options.uploadRetry){options.retry=(options.retry||0)+1;var delay=api.networkDownRetryTimeout;options.pause(options.file,options);setTimeout(function(){_this._send(options,data)},delay)}else{_this.end(xhr.status)}}else{_this.end(xhr.status)}xhr=null}};if(api.isArray(data)){xhr.setRequestHeader("Content-Type","multipart/form-data; boundary=_"+api.expando);var rawData=data.join("")+"--_"+api.expando+"--";if(xhr.sendAsBinary){xhr.sendAsBinary(rawData)}else{var bytes=Array.prototype.map.call(rawData,function(c){return c.charCodeAt(0)&255});xhr.send(new Uint8Array(bytes).buffer)}}else{xhr.send(data)}}}}};api.XHR=XHR})(window,FileAPI);(function(window,api){"use strict";var URL=window.URL||window.webkitURL,document=window.document,navigator=window.navigator,getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,html5=!!getMedia;api.support.media=html5;var Camera=function(video){this.video=video};Camera.prototype={isActive:function(){return!!this._active},start:function(callback){var _this=this,video=_this.video,_successId,_failId,_complete=function(err){_this._active=!err;clearTimeout(_failId);clearTimeout(_successId);callback&&callback(err,_this)};getMedia.call(navigator,{video:true},function(stream){_this.stream=stream;video.src=URL.createObjectURL(stream);_successId=setInterval(function(){if(_detectVideoSignal(video)){_complete(null)}},1e3);_failId=setTimeout(function(){_complete("timeout")},5e3);video.play()},_complete)},stop:function(){try{this._active=false;this.video.pause();this.stream.stop()}catch(err){}},shot:function(){return new Shot(this.video)}};Camera.get=function(el){return new Camera(el.firstChild)};Camera.publish=function(el,options,callback){if(typeof options=="function"){callback=options;options={}}options=api.extend({},{width:"100%",height:"100%",start:true},options);if(el.jquery){el=el[0]}var doneFn=function(err){if(err){callback(err)}else{var cam=Camera.get(el);if(options.start){cam.start(callback)}else{callback(null,cam)}}};el.style.width=_px(options.width);el.style.height=_px(options.height);if(api.html5&&html5){var video=document.createElement("video");video.style.width=_px(options.width);video.style.height=_px(options.height);if(window.jQuery){jQuery(el).empty()}else{el.innerHTML=""}el.appendChild(video);doneFn()}else{Camera.fallback(el,options,doneFn)}};Camera.fallback=function(el,options,callback){callback("not_support_camera")};var Shot=function(video){var canvas=video.nodeName?api.Image.toCanvas(video):video;var shot=api.Image(canvas);shot.type="image/png";shot.width=canvas.width;shot.height=canvas.height;shot.size=canvas.width*canvas.height*4;return shot};function _px(val){return val>=0?val+"px":val}function _detectVideoSignal(video){var canvas=document.createElement("canvas"),ctx,res=false;try{ctx=canvas.getContext("2d");ctx.drawImage(video,0,0,1,1);res=ctx.getImageData(0,0,1,1).data[4]!=255}catch(e){}return res}Camera.Shot=Shot;api.Camera=Camera})(window,FileAPI);(function(window,jQuery,api){"use strict";var document=window.document,location=window.location,navigator=window.navigator,_each=api.each;api.support.flash=function(){var mime=navigator.mimeTypes,has=false;if(navigator.plugins&&typeof navigator.plugins["Shockwave Flash"]=="object"){has=navigator.plugins["Shockwave Flash"].description&&!(mime&&mime["application/x-shockwave-flash"]&&!mime["application/x-shockwave-flash"].enabledPlugin)}else{try{has=!!(window.ActiveXObject&&new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(er){api.log("Flash -- does not supported.")}}if(has&&/^file:/i.test(location)){api.log("[warn] Flash does not work on `file:` protocol.")}return has}();api.support.flash&&(0||!api.html5||!api.support.html5||api.cors&&!api.support.cors||api.media&&!api.support.media)&&function(){var _attr=api.uid(),_retry=0,_files={},_rhttp=/^https?:/i,flash={_fn:{},init:function(){var child=document.body&&document.body.firstChild;if(child){do{if(child.nodeType==1){api.log("FlashAPI.state: awaiting");var dummy=document.createElement("div");dummy.id="_"+_attr;_css(dummy,{top:1,right:1,width:5,height:5,position:"absolute",zIndex:1e6+""});child.parentNode.insertBefore(dummy,child);flash.publish(dummy,_attr);return}}while(child=child.nextSibling)}if(_retry<10){setTimeout(flash.init,++_retry*50)}},publish:function(el,id,opts){opts=opts||{};el.innerHTML=_makeFlashHTML({id:id,src:_getUrl(api.flashUrl,"r="+api.version),wmode:opts.camera?"":"transparent",flashvars:"callback="+(opts.onEvent||"FileAPI.Flash.onEvent")+"&flashId="+id+"&storeKey="+navigator.userAgent.match(/\d/gi).join("")+"_"+api.version+(flash.isReady||(api.pingUrl?"&ping="+api.pingUrl:""))+"&timeout="+api.flashAbortTimeout+(opts.camera?"&useCamera="+_getUrl(api.flashWebcamUrl):"")+"&debug="+(api.debug?"1":"")},opts)},ready:function(){api.log("FlashAPI.state: ready");flash.ready=api.F;flash.isReady=true;flash.patch();flash.patchCamera&&flash.patchCamera();api.event.on(document,"mouseover",flash.mouseover);api.event.on(document,"click",function(evt){if(flash.mouseover(evt)){evt.preventDefault?evt.preventDefault():evt.returnValue=true}})},getEl:function(){return document.getElementById("_"+_attr)},getWrapper:function(node){do{if(/js-fileapi-wrapper/.test(node.className)){return node}}while((node=node.parentNode)&&node!==document.body)},mouseover:function(evt){var target=api.event.fix(evt).target;if(/input/i.test(target.nodeName)&&target.type=="file"&&!target.disabled){var state=target.getAttribute(_attr),wrapper=flash.getWrapper(target);if(api.multiFlash){if(state=="i"||state=="r"){return false}else if(state!="p"){target.setAttribute(_attr,"i");var dummy=document.createElement("div");if(!wrapper){api.log("[err] FlashAPI.mouseover: js-fileapi-wrapper not found");return}_css(dummy,{top:0,left:0,width:target.offsetWidth,height:target.offsetHeight,zIndex:1e6+"",position:"absolute"});wrapper.appendChild(dummy);flash.publish(dummy,api.uid());target.setAttribute(_attr,"p")}return true}else if(wrapper){var box=_getDimensions(wrapper);_css(flash.getEl(),box);flash.curInp=target}}else if(!/object|embed/i.test(target.nodeName)){_css(flash.getEl(),{top:1,left:1,width:5,height:5})}},onEvent:function(evt){var type=evt.type;if(type=="ready"){try{flash.getInput(evt.flashId).setAttribute(_attr,"r")}catch(e){}flash.ready();setTimeout(function(){flash.mouseenter(evt)},50);return true}else if(type==="ping"){api.log("(flash -> js).ping:",[evt.status,evt.savedStatus],evt.error)}else if(type==="log"){api.log("(flash -> js).log:",evt.target)}else if(type in flash){setTimeout(function(){api.log("FlashAPI.event."+evt.type+":",evt);flash[type](evt)},1)}},mouseenter:function(evt){var node=flash.getInput(evt.flashId);if(node){flash.cmd(evt,"multiple",node.getAttribute("multiple")!=null);var accept=[],exts={};_each((node.getAttribute("accept")||"").split(/,\s*/),function(mime){api.accept[mime]&&_each(api.accept[mime].split(" "),function(ext){exts[ext]=1})});_each(exts,function(i,ext){accept.push(ext)});flash.cmd(evt,"accept",accept.length?accept.join(",")+","+accept.join(",").toUpperCase():"*")}},get:function(id){return document[id]||window[id]||document.embeds[id]},getInput:function(id){if(api.multiFlash){try{var node=flash.getWrapper(flash.get(id));if(node){return node.getElementsByTagName("input")[0]}}catch(e){api.log('[err] Can not find "input" by flashId:',id,e)}}else{return flash.curInp}},select:function(evt){var inp=flash.getInput(evt.flashId),uid=api.uid(inp),files=evt.target.files,event;_each(files,function(file){api.checkFileObj(file)});_files[uid]=files;if(document.createEvent){event=document.createEvent("Event");event.files=files;event.initEvent("change",true,true);inp.dispatchEvent(event)}else if(jQuery){jQuery(inp).trigger({type:"change",files:files})}else{event=document.createEventObject();event.files=files;inp.fireEvent("onchange",event)}},cmd:function(id,name,data,last){try{api.log("(js -> flash)."+name+":",data);return flash.get(id.flashId||id).cmd(name,data)}catch(err){api.log("(js -> flash).onError:",err.toString());if(!last){setTimeout(function(){flash.cmd(id,name,data,true)},50)}}},patch:function(){api.flashEngine=true;_inherit(api,{getFiles:function(input,filter,callback){if(callback){api.filterFiles(api.getFiles(input),filter,callback);return null}var files=api.isArray(input)?input:_files[api.uid(input.target||input.srcElement||input)];if(!files){return this.parent.apply(this,arguments)}if(filter){filter=api.getFilesFilter(filter);files=api.filter(files,function(file){return filter.test(file.name)})}return files},getInfo:function(file,fn){if(_isHtmlFile(file)){this.parent.apply(this,arguments)}else if(file.isShot){fn(null,file.info={width:file.width,height:file.height})}else{if(!file.__info){var defer=file.__info=api.defer();flash.cmd(file,"getFileInfo",{id:file.id,callback:_wrap(function _(err,info){_unwrap(_);defer.resolve(err,file.info=info)})})}file.__info.then(fn)}}});api.support.transform=true;api.Image&&_inherit(api.Image.prototype,{get:function(fn,scaleMode){this.set({scaleMode:scaleMode||"noScale"});return this.parent(fn)},_load:function(file,fn){api.log("FlashAPI.Image._load:",file);if(_isHtmlFile(file)){this.parent.apply(this,arguments)}else{var _this=this;api.getInfo(file,function(err){fn.call(_this,err,file)})}},_apply:function(file,fn){api.log("FlashAPI.Image._apply:",file);if(_isHtmlFile(file)){this.parent.apply(this,arguments)}else{var m=this.getMatrix(file.info),doneFn=fn;flash.cmd(file,"imageTransform",{id:file.id,matrix:m,callback:_wrap(function _(err,base64){api.log("FlashAPI.Image._apply.callback:",err);_unwrap(_);if(err){doneFn(err)}else if(!api.support.html5&&(!api.support.dataURI||base64.length>3e4)){_makeFlashImage({width:m.deg%180?m.dh:m.dw,height:m.deg%180?m.dw:m.dh,scale:m.scaleMode},base64,doneFn)}else{if(m.filter){doneFn=function(err,img){if(err){fn(err)}else{api.Image.applyFilter(img,m.filter,function(){fn(err,this.canvas)})}}}api.newImage("data:"+file.type+";base64,"+base64,doneFn)}})})}},toData:function(fn){var file=this.file,info=file.info,matrix=this.getMatrix(info);api.log("FlashAPI.Image.toData");if(_isHtmlFile(file)){this.parent.apply(this,arguments)}else{if(matrix.deg=="auto"){matrix.deg=api.Image.exifOrientation[info&&info.exif&&info.exif.Orientation]||0}fn.call(this,!file.info,{id:file.id,flashId:file.flashId,name:file.name,type:file.type,matrix:matrix})}}});api.Image&&_inherit(api.Image,{fromDataURL:function(dataURL,size,callback){if(!api.support.dataURI||dataURL.length>3e4){_makeFlashImage(api.extend({scale:"exactFit"},size),dataURL.replace(/^data:[^,]+,/,""),function(err,el){callback(el)})}else{this.parent(dataURL,size,callback)}}});_inherit(api.Form.prototype,{toData:function(fn){var items=this.items,i=items.length;for(;i--;){if(items[i].file&&_isHtmlFile(items[i].blob)){return this.parent.apply(this,arguments)}}api.log("FlashAPI.Form.toData");fn(items)}});_inherit(api.XHR.prototype,{_send:function(options,formData){if(formData.nodeName||formData.append&&api.support.html5||api.isArray(formData)&&typeof formData[0]==="string"){return this.parent.apply(this,arguments)}var data={},files={},_this=this,flashId,fileId;_each(formData,function(item){if(item.file){files[item.name]=item=_getFileDescr(item.blob);fileId=item.id;flashId=item.flashId}else{data[item.name]=item.blob}});if(!fileId){flashId=_attr}if(!flashId){api.log("[err] FlashAPI._send: flashId -- undefined");return this.parent.apply(this,arguments)}else{api.log("FlashAPI.XHR._send: "+flashId+" -> "+fileId)}_this.xhr={headers:{},abort:function(){flash.cmd(flashId,"abort",{id:fileId})},getResponseHeader:function(name){return this.headers[name]},getAllResponseHeaders:function(){return this.headers}};var queue=api.queue(function(){flash.cmd(flashId,"upload",{url:_getUrl(options.url.replace(/([a-z]+)=(\?)&?/i,"")),data:data,files:fileId?files:null,headers:options.headers||{},callback:_wrap(function upload(evt){var type=evt.type,result=evt.result;api.log("FlashAPI.upload."+type);if(type=="progress"){evt.loaded=Math.min(evt.loaded,evt.total);evt.lengthComputable=true;options.progress(evt)}else if(type=="complete"){_unwrap(upload);if(typeof result=="string"){_this.responseText=result.replace(/%22/g,'"').replace(/%5c/g,"\\").replace(/%26/g,"&").replace(/%25/g,"%")}_this.end(evt.status||200)}else if(type=="abort"||type=="error"){_this.end(evt.status||0,evt.message);_unwrap(upload)}})})});_each(files,function(file){queue.inc();api.getInfo(file,queue.next)});queue.check()}})}};function _makeFlashHTML(opts){return('<object id="#id#" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+(opts.width||"100%")+'" height="'+(opts.height||"100%")+'">'+'<param name="movie" value="#src#" />'+'<param name="flashvars" value="#flashvars#" />'+'<param name="swliveconnect" value="true" />'+'<param name="allowscriptaccess" value="always" />'+'<param name="allownetworking" value="all" />'+'<param name="menu" value="false" />'+'<param name="wmode" value="#wmode#" />'+'<embed flashvars="#flashvars#" swliveconnect="true" allownetworking="all" allowscriptaccess="always" name="#id#" src="#src#" width="'+(opts.width||"100%")+'" height="'+(opts.height||"100%")+'" menu="false" wmode="transparent" type="application/x-shockwave-flash"></embed>'+"</object>").replace(/#(\w+)#/gi,function(a,name){return opts[name]})}function _css(el,css){if(el&&el.style){var key,val;for(key in css){val=css[key];if(typeof val=="number"){val+="px"}try{el.style[key]=val}catch(e){}}}}function _inherit(obj,methods){_each(methods,function(fn,name){var prev=obj[name];obj[name]=function(){this.parent=prev;return fn.apply(this,arguments)}})}function _isHtmlFile(file){return file&&!file.flashId}function _wrap(fn){var id=fn.wid=api.uid();flash._fn[id]=fn;return"FileAPI.Flash._fn."+id}function _unwrap(fn){try{flash._fn[fn.wid]=null;delete flash._fn[fn.wid]}catch(e){}}function _getUrl(url,params){if(!_rhttp.test(url)){if(/^\.\//.test(url)||"/"!=url.charAt(0)){var path=location.pathname;path=path.substr(0,path.lastIndexOf("/"));url=(path+"/"+url).replace("/./","/")}if("//"!=url.substr(0,2)){url="//"+location.host+url}if(!_rhttp.test(url)){url=location.protocol+url}}if(params){url+=(/\?/.test(url)?"&":"?")+params}return url}function _makeFlashImage(opts,base64,fn){var key,flashId=api.uid(),el=document.createElement("div"),attempts=10;for(key in opts){el.setAttribute(key,opts[key]);el[key]=opts[key]}_css(el,opts);opts.width="100%";opts.height="100%";el.innerHTML=_makeFlashHTML(api.extend({id:flashId,src:_getUrl(api.flashImageUrl,"r="+api.uid()),wmode:"opaque",flashvars:"scale="+opts.scale+"&callback="+_wrap(function _(){_unwrap(_);if(--attempts>0){_setImage()}return true})},opts));function _setImage(){try{var img=flash.get(flashId);img.setImage(base64)}catch(e){api.log('[err] FlashAPI.Preview.setImage -- can not set "base64":',e)}}fn(false,el);el=null}function _getFileDescr(file){return{id:file.id,name:file.name,matrix:file.matrix,flashId:file.flashId}}function _getDimensions(el){var box=el.getBoundingClientRect(),body=document.body,docEl=(el&&el.ownerDocument).documentElement;return{top:box.top+(window.pageYOffset||docEl.scrollTop)-(docEl.clientTop||body.clientTop||0),left:box.left+(window.pageXOffset||docEl.scrollLeft)-(docEl.clientLeft||body.clientLeft||0),width:box.right-box.left,height:box.bottom-box.top}}api.Flash=flash;api.newImage("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",function(err,img){api.support.dataURI=!(img.width!=1||img.height!=1);flash.init()})}()})(window,window.jQuery,FileAPI);(function(window,jQuery,api){"use strict";var _each=api.each,_cameraQueue=[];if(api.support.flash&&(api.media&&(!api.support.media||!api.html5))){(function(){function _wrap(fn){var id=fn.wid=api.uid();api.Flash._fn[id]=fn;return"FileAPI.Flash._fn."+id}function _unwrap(fn){try{api.Flash._fn[fn.wid]=null;delete api.Flash._fn[fn.wid]}catch(e){}}var flash=api.Flash;api.extend(api.Flash,{patchCamera:function(){api.Camera.fallback=function(el,options,callback){var camId=api.uid();api.log("FlashAPI.Camera.publish: "+camId);flash.publish(el,camId,api.extend(options,{camera:true,onEvent:_wrap(function _(evt){if(evt.type==="camera"){_unwrap(_);if(evt.error){api.log("FlashAPI.Camera.publish.error: "+evt.error);callback(evt.error)}else{api.log("FlashAPI.Camera.publish.success: "+camId);callback(null)}}})}))};_each(_cameraQueue,function(args){api.Camera.fallback.apply(api.Camera,args)});_cameraQueue=[];api.extend(api.Camera.prototype,{_id:function(){return this.video.id},start:function(callback){var _this=this;flash.cmd(this._id(),"camera.on",{callback:_wrap(function _(evt){_unwrap(_);if(evt.error){api.log("FlashAPI.camera.on.error: "+evt.error);callback(evt.error,_this)}else{api.log("FlashAPI.camera.on.success: "+_this._id());_this._active=true;callback(null,_this)}})})},stop:function(){this._active=false;flash.cmd(this._id(),"camera.off")},shot:function(){api.log("FlashAPI.Camera.shot:",this._id());var shot=api.Flash.cmd(this._id(),"shot",{});shot.type="image/png";shot.flashId=this._id();shot.isShot=true;return new api.Camera.Shot(shot)}})}});api.Camera.fallback=function(){_cameraQueue.push(arguments)}})()}})(window,window.jQuery,FileAPI);if(typeof define==="function"&&define.amd){define("FileAPI",[],function(){return FileAPI})}
(function($,api){"use strict";var noop=$.noop,oldJQ=!$.fn.prop,propFn=oldJQ?"attr":"prop",removePropFn=oldJQ?"removeAttr":"removeProp",_dataAttr="data-fileapi",_dataFileId="data-fileapi-id",_slice=[].slice,_each=api.each,_extend=api.extend,_bind=function(ctx,fn){var args=_slice.call(arguments,2);return fn.bind?fn.bind.apply(fn,[ctx].concat(args)):function(){return fn.apply(ctx,args.concat(_slice.call(arguments)))}},_optDataAttr=function(name){return"["+_dataAttr+'="'+name+'"]'},_isID=function(selector){return selector.indexOf("#")===0};var Plugin=function(el,options){this.$el=el=$(el).on("change.fileapi",'input[type="file"]',_bind(this,this._onSelect));this.el=el[0];this._options={};this.options={url:0,data:{},accept:0,multiple:false,paramName:0,dataType:"json",duplicate:false,uploadRetry:0,networkDownRetryTimeout:5e3,chunkSize:0,chunkUploadRetry:3,chunkNetworkDownRetryTimeout:2e3,maxSize:0,maxFiles:0,imageSize:0,sortFn:0,filterFn:0,autoUpload:false,clearOnSelect:void 0,clearOnComplete:void 0,lang:{B:"bytes",KB:"KB",MB:"MB",GB:"GB",TB:"TB"},sizeFormat:"0.00",imageOriginal:true,imageTransform:0,imageAutoOrientation:!!FileAPI.support.exif,elements:{ctrl:{upload:_optDataAttr("ctrl.upload"),reset:_optDataAttr("ctrl.reset"),abort:_optDataAttr("ctrl.abort")},empty:{show:_optDataAttr("empty.show"),hide:_optDataAttr("empty.hide")},emptyQueue:{show:_optDataAttr("emptyQueue.show"),hide:_optDataAttr("emptyQueue.hide")},active:{show:_optDataAttr("active.show"),hide:_optDataAttr("active.hide")},size:_optDataAttr("size"),name:_optDataAttr("name"),progress:_optDataAttr("progress"),list:_optDataAttr("list"),file:{tpl:_optDataAttr("file.tpl"),progress:_optDataAttr("file.progress"),active:{show:_optDataAttr("file.active.show"),hide:_optDataAttr("file.active.hide")},preview:{el:0,get:0,width:0,height:0,processing:0},abort:_optDataAttr("file.abort"),remove:_optDataAttr("file.remove"),rotate:_optDataAttr("file.rotate")},dnd:{el:_optDataAttr("dnd"),hover:"dnd_hover",fallback:_optDataAttr("dnd.fallback")}},onDrop:noop,onDropHover:noop,onSelect:noop,onBeforeUpload:noop,onUpload:noop,onProgress:noop,onComplete:noop,onFilePrepare:noop,onFileUpload:noop,onFileProgress:noop,onFileComplete:noop,onFileRemove:null,onFileRemoveCompleted:null};$.extend(true,this.options,options);options=this.options;this.option("elements.file.preview.rotate",options.imageAutoOrientation);if(!options.url){var url=this.$el.attr("action")||this.$el.find("form").attr("action");if(url){options.url=url}else{this._throw("url — is not defined")}}this.$files=this.$elem("list");this.$fileTpl=this.$elem("file.tpl");this.itemTplFn=$.fn.fileapi.tpl($("<div/>").append(this.$elem("file.tpl")).html());_each(options,function(value,option){this._setOption(option,value)},this);this.$el.on("reset.fileapi",_bind(this,this._onReset)).on("submit.fileapi",_bind(this,this._onSubmit)).on("upload.fileapi progress.fileapi complete.fileapi",_bind(this,this._onUploadEvent)).on("fileupload.fileapi fileprogress.fileapi filecomplete.fileapi",_bind(this,this._onFileUploadEvent)).on("click","["+_dataAttr+"]",_bind(this,this._onActionClick));var ctrl=options.elements.ctrl;if(ctrl){this._listen("click",ctrl.reset,_bind(this,this._onReset));this._listen("click",ctrl.upload,_bind(this,this._onSubmit));this._listen("click",ctrl.abort,_bind(this,this._onAbort))}var dnd=FileAPI.support.dnd;this.$elem("dnd.el",true).toggle(dnd);this.$elem("dnd.fallback").toggle(!dnd);if(dnd){this.$elem("dnd.el",true).dnd(_bind(this,this._onDropHover),_bind(this,this._onDrop))}this.$progress=this.$elem("progress");if(options.clearOnSelect===void 0){options.clearOnSelect=!options.multiple}this.clear();if($.isArray(options.files)){this.files=$.map(options.files,function(file){if($.type(file)==="string"){file={src:file,size:0}}file.name=file.name||file.src.split("/").pop();file.type=file.type||/\.(jpe?g|png|bmp|gif|tiff?)/i.test(file.src)&&"image/"+file.src.split(".").pop();file.complete=true;return file});this._redraw()}};Plugin.prototype={constructor:Plugin,_throw:function(msg){throw"jquery.fileapi: "+msg},_getFiles:function(evt,fn){var opts=this.options,maxSize=opts.maxSize,maxFiles=opts.maxFiles,filterFn=opts.filterFn,countFiles=this.files.length,files=api.getFiles(evt),data={all:files,files:[],other:[],duplicate:opts.duplicate?[]:this._extractDuplicateFiles(files)},imageSize=opts.imageSize,_this=this;if(imageSize||filterFn){api.filterFiles(files,function(file,info){if(info&&imageSize){_checkFileByCriteria(file,"minWidth",imageSize,info);_checkFileByCriteria(file,"minHeight",imageSize,info);_checkFileByCriteria(file,"maxWidth",imageSize,info);_checkFileByCriteria(file,"maxHeight",imageSize,info)}_checkFileByCriteria(file,"maxSize",maxSize,file.size);return!file.errors&&(!filterFn||filterFn(file,info))},function(success,rejected){_extractFilesOverLimit(maxFiles,countFiles,success,rejected);data.other=rejected;data.files=success;fn.call(_this,data)})}else{_each(files,function(file){_checkFileByCriteria(file,"maxSize",maxSize,file.size);data[file.errors?"other":"files"].push(file)});_extractFilesOverLimit(maxFiles,countFiles,data.files,data.other);fn.call(_this,data)}},_extractDuplicateFiles:function(list){var duplicates=[],i=list.length,files=this.files,j;while(i--){j=files.length;while(j--){if(this._fileCompare(list[i],files[j])){duplicates.push(list.splice(i,1));break}}}return duplicates},_fileCompare:function(A,B){return A.size==B.size&&A.name==B.name},_getFormatedSize:function(size){var opts=this.options,postfix="B";if(size>=api.TB){size/=api[postfix="TB"]}else if(size>=api.GB){size/=api[postfix="GB"]}else if(size>=api.MB){size/=api[postfix="MB"]}else if(size>=api.KB){size/=api[postfix="KB"]}return opts.sizeFormat.replace(/^\d+([^\d]+)(\d*)/,function(_,separator,fix){size=(parseFloat(size)||0).toFixed(fix.length);return(size+"").replace(".",separator)+" "+opts.lang[postfix]})},_onSelect:function(evt){if(this.options.clearOnSelect){this.queue=[];this.files=[]}this._getFiles(evt,_bind(this,function(data){if(data.all.length&&this.emit("select",data)!==false){this.add(data.files)}FileAPI.reset(evt.target)}))},_onActionClick:function(evt){var el=evt.currentTarget,act=$.attr(el,_dataAttr),uid=$(el).closest("["+_dataFileId+"]",this.$el).attr(_dataFileId),file=this._getFile(uid),prevent=true;if(!this.$file(uid).attr("disabled")){if("file.remove"==act){if(file&&this.emit("fileRemove"+(file.complete?"Completed":""),file)){this.remove(uid)}}else if(/^file\.rotate/.test(act)){this.rotate(uid,/ccw/.test(act)?"-=90":"+=90")}else{prevent=false}}if(prevent){evt.preventDefault()}},_listen:function(name,selector,fn){selector&&_each($.trim(selector).split(","),function(selector){selector=$.trim(selector);if(_isID(selector)){$(selector).on(name+".fileapi",fn)}else{this.$el.on(name+".fileapi",selector,fn)}},this)},_onSubmit:function(evt){evt.preventDefault();this.upload()},_onReset:function(evt){evt.preventDefault();this.clear(true)},_onAbort:function(evt){evt.preventDefault();this.abort()},_onDrop:function(files){this._getFiles(files,function(data){if(this.emit("drop",data)!==false){this.add(data.files)}})},_onDropHover:function(state,evt){if(this.emit("dropHover",{state:state,event:evt})!==false){var hover=this.option("elements.dnd.hover");if(hover){$(evt.currentTarget).toggleClass(hover,state)}}},_getFile:function(uid){return api.filter(this.files,function(file){return api.uid(file)==uid})[0]},_getUploadEvent:function(xhr,extra){xhr=this.xhr||xhr;var evt={xhr:xhr,file:this.xhr.currentFile,files:this.xhr.files,widget:this};return _extend(evt,extra)},_emitUploadEvent:function(prefix,file,xhr){var evt=this._getUploadEvent(xhr);this.emit(prefix+"Upload",evt)},_emitProgressEvent:function(prefix,event,file,xhr){var evt=this._getUploadEvent(xhr,event);this.emit(prefix+"Progress",evt)},_emitCompleteEvent:function(prefix,err,xhr,file){var evt=this._getUploadEvent(xhr,{error:err,status:xhr.status,statusText:xhr.statusText,result:xhr.responseText});if(prefix=="file"){file.complete=true}if(this.options.dataType=="json"){try{evt.result=$.parseJSON(evt.result)}catch(err){evt.error=err}}this.emit(prefix+"Complete",evt)},_onUploadEvent:function(evt,ui){var _this=this,$progress=_this.$progress,type=evt.type;if(type=="progress"){$progress.stop().animate({width:ui.loaded/ui.total*100+"%"},300)}else if(type=="upload"){$progress.width(0)}else{var fn=function(){$progress.dequeue();_this[_this.options.clearOnComplete?"clear":"dequeue"]()};this.xhr=null;this.active=false;if($progress.length){$progress.queue(fn)}else{fn()}}},_onFileUploadPrepare:function(file,opts){var uid=api.uid(file),deg=this._rotate[uid],crop=this._crop[uid],resize=this._resize[uid],evt=this._getUploadEvent(this.xhr);if(deg||crop||resize){var trans=$.extend(true,{},opts.imageTransform||{});deg=deg!=null?deg:this.options.imageAutoOrientation?"auto":void 0;if($.isEmptyObject(trans)||_isOriginTransform(trans)){_extend(trans,resize);trans.crop=crop;trans.rotate=deg}else{_each(trans,function(opts){_extend(opts,resize);opts.crop=crop;opts.rotate=deg})}opts.imageTransform=trans}evt.file=file;evt.options=opts;this.emit("filePrepare",evt)},_onFileUploadEvent:function(evt,ui){var _this=this,type=evt.type.substr(4),uid=api.uid(ui.file),$file=this.$file(uid),$progress=this._$fileprogress,opts=this.options;if(this.__fileId!==uid){this.__fileId=uid;this._$fileprogress=$progress=this.$elem("file.progress",$file)}if(type=="progress"){$progress.stop().animate({width:ui.loaded/ui.total*100+"%"},300)}else if(type=="upload"||type=="complete"){var fn=function(){var elem="file."+type,$remove=_this.$elem("file.remove",$file);if(type=="upload"){$remove.hide();$progress.width(0)}else if(opts.onFileRemoveCompleted){$remove.show()}$progress.dequeue();_this.$elem(elem+".show",$file).show();_this.$elem(elem+".hide",$file).hide()};if($progress.length){$progress.queue(fn)}else{fn()}if(type=="complete"){this.uploaded.push(ui.file);delete this._rotate[uid]}}},_redraw:function(clearFiles,clearPreview){var files=this.files,active=!!this.active,empty=!files.length&&!active,emptyQueue=!this.queue.length&&!active,name=[],size=0,$files=this.$files,offset=$files.children().length,preview=this.option("elements.preview"),filePreview=this.option("elements.file.preview");if(clearFiles){this.$files.empty()}if(clearPreview&&preview&&preview.el&&!this.queue.length){this.$(preview.el).empty()}_each(files,function(file,i){var uid=api.uid(file);name.push(file.name);size+=file.complete?0:file.size;if(preview&&preview.el){this._makeFilePreview(uid,file,preview,true)}else if($files.length&&!this.$file(uid).length){var html=this.itemTplFn({$idx:offset+i,uid:uid,name:file.name,type:file.type,size:file.size,complete:!!file.complete,sizeText:this._getFormatedSize(file.size)}),$file=$(html).attr(_dataFileId,uid);file.$el=$file;$files.append($file);if(file.complete){this.$elem("file.upload.hide",$file).hide();this.$elem("file.complete.hide",$file).hide()}if(filePreview.el){this._makeFilePreview(uid,file,filePreview)}}},this);this.$elem("name").text(name.join(", "));this.$elem("size").text(!emptyQueue?this._getFormatedSize(size):"");this.$elem("empty.show").toggle(empty);this.$elem("empty.hide").toggle(!empty);this.$elem("emptyQueue.show").toggle(emptyQueue);this.$elem("emptyQueue.hide").toggle(!emptyQueue);this.$elem("active.show").toggle(active);this.$elem("active.hide").toggle(!active);this.$(".js-fileapi-wrapper,:file")[active?"attr":"removeAttr"]("aria-disabled",active)[propFn]("disabled",active);this._disableElem("ctrl.upload",emptyQueue||active);this._disableElem("ctrl.reset",emptyQueue||active);this._disableElem("ctrl.abort",!active)},_disableElem:function(name,state){this.$elem(name)[state?"attr":"removeAttr"]("aria-disabled","disabled")[propFn]("disabled",state)},_makeFilePreview:function(uid,file,opts,global){var _this=this,$el=global?_this.$(opts.el):_this.$file(uid).find(opts.el);if(!_this._crop[uid]){if(/^image/.test(file.type)){var image=api.Image(file.src||file),doneFn=function(){image.get(function(err,img){if(!_this._crop[uid]){if(err){opts.get&&opts.get($el,file);_this.emit("previewError",[err,file])}else{$el.html(img)}}})};if(opts.width){image.preview(opts.width,opts.height)}if(opts.rotate){image.rotate("auto")}if(opts.processing){opts.processing(file,image,doneFn)}else{doneFn()}}else{opts.get&&opts.get($el,file)}}},emit:function(name,arg){var opts=this.options,evt=$.Event(name.toLowerCase()),res;evt.widget=this;name=$.camelCase("on-"+name);if($.isFunction(opts[name])){res=opts[name].call(this.el,evt,arg)}this.$el.triggerHandler(evt,arg);return res!==false&&!evt.isDefaultPrevented()},add:function(files,clear){files=[].concat(files);if(files.length){var opts=this.options,sortFn=opts.sortFn;if(sortFn){files.sort(sortFn)}if(this.xhr){this.xhr.append(files)}this.queue=clear?files:this.queue.concat(files);this.files=clear?files:this.files.concat(files);if(this.active){this.xhr.append(files);this._redraw(clear)}else{this._redraw(clear);if(this.options.autoUpload){this.upload()}}}},$:function(sel,ctx){if(typeof sel==="string"){sel=/^#/.test(sel)?sel:(ctx?$(ctx):this.$el).find(sel)}return $(sel)},$elem:function(name,up,ctx){if(up&&up.jquery){ctx=up;up=false}var sel=this.option("elements."+name);if(sel===void 0&&up){sel=this.option("elements."+name.substr(0,name.lastIndexOf(".")))}return this.$($.type(sel)!="string"&&$.isEmptyObject(sel)?[]:sel,ctx)},$file:function(uid){return this.$("["+_dataFileId+'="'+uid+'"]')},option:function(name,value){if(value!==void 0&&$.isPlainObject(value)){_each(value,function(val,key){this.option(name+"."+key,val)},this);return this}var opts=this.options,val=opts[name],i=0,len,part;if(name.indexOf(".")!=-1){val=opts;name=name.split(".");len=name.length;for(;i<len;i++){part=name[i];if(value!==void 0&&len-i===1){val[part]=value;break}else if(!val[part]){val[part]={}}val=val[part]}}else if(value!==void 0){opts[name]=value}if(value!==void 0){this._setOption(name,value,this._options[name]);this._options[name]=value}return value!==void 0?value:val},_setOption:function(name,nVal){switch(name){case"accept":case"multiple":this.$(":file")[nVal?propFn:removePropFn](name,nVal);break;case"paramName":nVal&&this.$(":file")[propFn]("name",nVal);break}},serialize:function(){var obj={},val;this.$el.find(":input").each(function(name,node){if((name=node.name)&&!node.disabled&&(node.checked||/select|textarea|input/i.test(node.nodeName)&&!/checkbox|radio|file/i.test(node.type))){val=$(node).val();if(obj[name]!==void 0){if(!obj[name].push){obj[name]=[obj[name]]}obj[name].push(val)}else{obj[name]=val}}});return obj},upload:function(){if(!this.active&&this.emit("beforeUpload",{widget:this,files:this.queue})){this.active=true;var $el=this.$el,opts=this.options,files={},uploadOpts={url:opts.url,data:_extend({},this.serialize(),opts.data),headers:opts.headers,files:files,uploadRetry:opts.uploadRetry,networkDownRetryTimeout:opts.networkDownRetryTimeout,chunkSize:opts.chunkSize,chunkUploadRetry:opts.chunkUploadRetry,chunkNetworkDownRetryTimeout:opts.chunkNetworkDownRetryTimeout,prepare:_bind(this,this._onFileUploadPrepare),imageOriginal:opts.imageOriginal,imageTransform:opts.imageTransform,imageAutoOrientation:opts.imageAutoOrientation};files[$el.find(":file").attr("name")||"files[]"]=this.queue;_each(["Upload","Progress","Complete"],function(name){var lowerName=name.toLowerCase();uploadOpts[lowerName]=_bind(this,this["_emit"+name+"Event"],"");uploadOpts["file"+lowerName]=_bind(this,this["_emit"+name+"Event"],"file")},this);this.xhr=api.upload(uploadOpts);this._redraw()}},abort:function(text){if(this.active&&this.xhr){this.xhr.abort(text)}},crop:function(file,coords){var uid=api.uid(file),opts=this.options,preview=opts.multiple?this.option("elements.file.preview"):opts.elements.preview,$el=(opts.multiple?this.$file(uid):this.$el).find(preview&&preview.el);if($el.length){api.getInfo(file,_bind(this,function(err,info){if(err){this.emit("previewError",[err,file])}else{if(!$el.find("div>div").length){$el.html($("<div><div></div></div>").css(preview).css("overflow","hidden"))}if(this.__cropFile!==file){this.__cropFile=file;api.Image(file).rotate(opts.imageAutoOrientation?"auto":0).get(function(err,img){$el.find(">div>div").html($(img).width("100%").height("100%"))},"exactFit")}var pw=preview.width,ph=preview.height,mx=pw,my=ph,rx=pw/coords.rw,ry=ph/coords.rh;if(preview.keepAspectRatio){if(rx>1&&ry>1){rx=ry=1;my=coords.h;mx=coords.w}else{if(rx<ry){ry=rx;my=pw*coords.rh/coords.rw}else{rx=ry;mx=ph*coords.rw/coords.rh}}}$el.find(">div>div").css({width:Math.round(rx*info[coords.flip?"height":"width"]),height:Math.round(ry*info[coords.flip?"width":"height"]),marginLeft:-Math.round(rx*coords.rx),marginTop:-Math.round(ry*coords.ry)});if(preview.keepAspectRatio){$el.find(">div").css({width:Math.round(mx),height:Math.round(my),marginLeft:mx<pw?Math.round((pw-mx)/2):0,marginTop:my<ph?Math.round((ph-my)/2):0})}}}))}this._crop[uid]=coords},resize:function(file,width,height,type){this._resize[api.uid(file)]={type:type,width:width,height:height}},rotate:function(file,deg){var uid=$.type(file)=="string"?file:api.uid(file),opts=this.options,preview=opts.multiple?this.option("elements.file.preview"):opts.elements.preview,$el=(opts.multiple?this.$file(uid):this.$el).find(preview&&preview.el),_rotate=this._rotate;file=this._getFile(uid);api.getInfo(file,function(err,info){var orientation=info&&info.exif&&info.exif.Orientation,startDeg=opts.imageAutoOrientation&&api.Image.exifOrientation[orientation]||0;if(_rotate[uid]==null){_rotate[uid]=startDeg||0}if(/([+-])=/.test(deg)){_rotate[uid]=deg=_rotate[uid]+(RegExp.$1=="+"?1:-1)*deg.substr(2)}else{_rotate[uid]=deg}file.rotate=deg;deg-=startDeg;$el.css({"-webkit-transform":"rotate("+deg+"deg)","-moz-transform":"rotate("+deg+"deg)",transform:"rotate("+deg+"deg)"})})},remove:function(file){var uid=typeof file=="object"?api.uid(file):file;this.$file(uid).remove();this.queue=api.filter(this.queue,function(file){return api.uid(file)!=uid});this.files=api.filter(this.files,function(file){return api.uid(file)!=uid});this._redraw()},clear:function(all){this._crop={};this._resize={};this._rotate={};this.queue=[];this.files=[];this.uploaded=[];all=all===void 0?true:all;this._redraw(all,all)},dequeue:function(){this.queue=[];this._redraw()},widget:function(){return this},toString:function(){return"[jQuery.FileAPI object]"},destroy:function(){this.$files.empty().append(this.$fileTpl);this.$el.off(".fileapi").removeData("fileapi");_each(this.options.elements.ctrl,function(selector){_isID(selector)&&$(selector).off("click.fileapi")})}};function _isOriginTransform(trans){var key;for(key in trans){if(trans.hasOwnProperty(key)){if(!(trans[key]instanceof Object||key==="overlay")){return true}}}return false}function _checkFileByCriteria(file,name,imageSize,info){if(imageSize&&info){var excepted=imageSize>0?imageSize:imageSize[name],actual=info>0?info:info[name.substr(3).toLowerCase()],val=excepted-actual,isMax=/max/.test(name);if(isMax&&val<0||!isMax&&val>0){if(!file.errors){file.errors={}}file.errors[name]=Math.abs(val)}}}function _extractFilesOverLimit(limit,countFiles,files,other){if(limit){var delta=files.length-(limit-countFiles);if(delta>0){_each(files.splice(0,delta),function(file,i){_checkFileByCriteria(file,"maxFiles",-1,i);other.push(file)})}}}$.fn.fileapi=function(options,value){var plugin=this.data("fileapi");if(plugin){if(options==="widget"){return plugin}if(typeof options=="string"){var fn=plugin[options],res;if($.isFunction(fn)){res=fn.apply(plugin,_slice.call(arguments,1))}else if(fn===void 0){res=plugin.option(options,value)}else if(options==="files"){res=fn}return res===void 0?this:res}}else if(options==null||typeof options=="object"){this.data("fileapi",new Plugin(this,options))}return this};$.fn.fileapi.version="0.4.9";$.fn.fileapi.tpl=function(text){var index=0;var source="__b+='";text.replace(/(?:&lt;|<)%([-=])?([\s\S]+?)%(?:&gt;|>)|$/g,function(match,mode,expr,offset){source+=text.slice(index,offset).replace(/[\r\n"']/g,function(match){return"\\"+match});if(expr){if(mode){source+="'+\n((__x=("+expr+"))==null?'':"+(mode=="-"?"__esc(__x)":"__x")+")\n+'"}else{source+="';\n"+expr+"\n__b+='"}}index=offset+match.length;return match});return new Function("ctx","var __x,__b='',"+"__esc=function(val){return typeof val=='string'?val.replace(/</g,'&lt;').replace(/\"/g,'&quot;'):val;};"+"with(ctx||{}){\n"+source+"';\n}return __b;")};$.fn.webcam=function(options){var el=this,ret=el,$el=$(el),key="fileapi-camera",inst=$el.data(key);if(inst===true){api.log("[webcam.warn] not ready.");ret=null}else if(options==="widget"){ret=inst}else if(options==="destroy"){inst.stop();$el.empty()}else if(inst){ret=inst[options]()}else if(inst===false){api.log("[webcam.error] does not work.");ret=null}else{$el.data(key,true);options=_extend({success:noop,error:noop},options);FileAPI.Camera.publish($el,options,function(err,cam){$el.data(key,err?false:cam);options[err?"error":"success"].call(el,err||cam)})}return ret};$.fn.cropper=function(opts){var $el=this,file=opts.file;if(typeof opts==="string"){$el.first().Jcrop.apply($el,arguments)}else{var minSize=opts.minSize||[0,0],ratio=opts.aspectRatio||minSize[0]/minSize[1];if($.isArray(opts.minSize)&&opts.aspectRatio===void 0&&ratio>0){opts.aspectRatio=ratio}api.getInfo(file,function(err,info){var Image=api.Image(file),maxSize=opts.maxSize,deg=file.rotate;if(maxSize){Image.resize(Math.max(maxSize[0],minSize[0]),Math.max(maxSize[1],minSize[1]),"max")}Image.rotate(deg===void 0?"auto":deg).get(function(err,img){var selection=opts.selection,minSide=Math.min(img.width,img.height),selWidth=minSide,selHeight=minSide/ratio,deg=FileAPI.Image.exifOrientation[info.exif&&info.exif.Orientation]||0;if(selection){if(/%/.test(selection)||selection>0&&selection<1){selection=parseFloat(selection,10)/(selection>0?1:100);selWidth*=selection;selHeight*=selection}var selLeft=(img.width-selWidth)/2,selTop=(img.height-selHeight)/2;opts.setSelect=[selLeft|0,selTop|0,selLeft+selWidth|0,selTop+selHeight|0]}_each(["onSelect","onChange"],function(name,fn){if(fn=opts[name]){opts[name]=function(coords){var flip=deg%180,ow=info.width,oh=info.height,fx=coords.x/img.width,fy=coords.y/img.height,fw=coords.w/img.width,fh=coords.h/img.height,x=ow*(flip?fy:fx),y=oh*(flip?1-(coords.x+coords.w)/img.width:fy),w=ow*(flip?fh:fw),h=oh*(flip?fw:fh);fn({x:x,y:y,w:w,h:h,rx:fx*(flip?oh:ow),ry:fy*(flip?ow:oh),rw:fw*(flip?oh:ow),rh:fh*(flip?ow:oh),lx:coords.x,ly:coords.y,lw:coords.w,lh:coords.h,lx2:coords.x2,ly2:coords.y2,deg:deg,flip:flip})}}});var $inner=$("<div/>").css("lineHeight",0).append($(img).css("margin",0));$el.html($inner);_each(opts.minSize,function(width,height){if(width>minSide){opts.minSize[0]=minSide}if(height>minSide){opts.minSize[1]=minSide}});$inner.Jcrop(opts).trigger("resize")})})}return $el}})(jQuery,FileAPI);
(function($){$.Jcrop=function(obj,opt){var options=$.extend({},$.Jcrop.defaults),docOffset,_ua=navigator.userAgent.toLowerCase(),is_msie=/msie/.test(_ua),ie6mode=/msie [1-6]\./.test(_ua);function px(n){return Math.round(n)+"px"}function cssClass(cl){return options.baseClass+"-"+cl}function supportsColorFade(){return $.fx.step.hasOwnProperty("backgroundColor")}function getPos(obj){var pos=$(obj).offset();return[pos.left,pos.top]}function mouseAbs(e){return[e.pageX-docOffset[0],e.pageY-docOffset[1]]}function setOptions(opt){if(typeof opt!=="object")opt={};options=$.extend(options,opt);$.each(["onChange","onSelect","onRelease","onDblClick"],function(i,e){if(typeof options[e]!=="function")options[e]=function(){}})}function startDragMode(mode,pos,touch){docOffset=getPos($img);Tracker.setCursor(mode==="move"?mode:mode+"-resize");if(mode==="move"){return Tracker.activateHandlers(createMover(pos),doneSelect,touch)}var fc=Coords.getFixed();var opp=oppLockCorner(mode);var opc=Coords.getCorner(oppLockCorner(opp));Coords.setPressed(Coords.getCorner(opp));Coords.setCurrent(opc);Tracker.activateHandlers(dragmodeHandler(mode,fc),doneSelect,touch)}function dragmodeHandler(mode,f){return function(pos){if(!options.aspectRatio){switch(mode){case"e":pos[1]=f.y2;break;case"w":pos[1]=f.y2;break;case"n":pos[0]=f.x2;break;case"s":pos[0]=f.x2;break}}else{switch(mode){case"e":pos[1]=f.y+1;break;case"w":pos[1]=f.y+1;break;case"n":pos[0]=f.x+1;break;case"s":pos[0]=f.x+1;break}}Coords.setCurrent(pos);Selection.update()}}function createMover(pos){var lloc=pos;KeyManager.watchKeys();return function(pos){Coords.moveOffset([pos[0]-lloc[0],pos[1]-lloc[1]]);lloc=pos;Selection.update()}}function oppLockCorner(ord){switch(ord){case"n":return"sw";case"s":return"nw";case"e":return"nw";case"w":return"ne";case"ne":return"sw";case"nw":return"se";case"se":return"nw";case"sw":return"ne"}}function createDragger(ord){return function(e){if(options.disabled){return false}if(ord==="move"&&!options.allowMove){return false}docOffset=getPos($img);btndown=true;startDragMode(ord,mouseAbs(e));e.stopPropagation();e.preventDefault();return false}}function presize($obj,w,h){var nw=$obj.width(),nh=$obj.height();if(nw>w&&w>0){nw=w;nh=w/$obj.width()*$obj.height()}if(nh>h&&h>0){nh=h;nw=h/$obj.height()*$obj.width()}xscale=$obj.width()/nw;yscale=$obj.height()/nh;$obj.width(nw).height(nh)}function unscale(c){return{x:c.x*xscale,y:c.y*yscale,x2:c.x2*xscale,y2:c.y2*yscale,w:c.w*xscale,h:c.h*yscale}}function doneSelect(pos){var c=Coords.getFixed();if(c.w>options.minSelect[0]&&c.h>options.minSelect[1]){Selection.enableHandles();Selection.done()}else{Selection.release()}Tracker.setCursor(options.allowSelect?"crosshair":"default")}function newSelection(e){if(options.disabled){return false}if(!options.allowSelect){return false}btndown=true;docOffset=getPos($img);Selection.disableHandles();Tracker.setCursor("crosshair");var pos=mouseAbs(e);Coords.setPressed(pos);Selection.update();Tracker.activateHandlers(selectDrag,doneSelect,e.type.substring(0,5)==="touch");KeyManager.watchKeys();e.stopPropagation();e.preventDefault();return false}function selectDrag(pos){Coords.setCurrent(pos);Selection.update()}function newTracker(){var trk=$("<div></div>").addClass(cssClass("tracker"));if(is_msie){trk.css({opacity:0,backgroundColor:"white"})}return trk}if(typeof obj!=="object"){obj=$(obj)[0]}if(typeof opt!=="object"){opt={}}setOptions(opt);var img_css={border:"none",visibility:"visible",margin:0,padding:0,position:"absolute",top:0,left:0};var $origimg=$(obj),img_mode=true;if(obj.tagName=="IMG"){if($origimg[0].width!=0&&$origimg[0].height!=0){$origimg.width($origimg[0].width);$origimg.height($origimg[0].height)}else{var tempImage=new Image;tempImage.src=$origimg[0].src;$origimg.width(tempImage.width);$origimg.height(tempImage.height)}var $img=$origimg.clone().removeAttr("id").css(img_css).show();$img.width($origimg.width());$img.height($origimg.height());$origimg.after($img).hide()}else{$img=$origimg.css(img_css).show();img_mode=false;if(options.shade===null){options.shade=true}}presize($img,options.boxWidth,options.boxHeight);var boundx=$img.width(),boundy=$img.height(),$div=$("<div />").width(boundx).height(boundy).addClass(cssClass("holder")).css({position:"relative",backgroundColor:options.bgColor}).insertAfter($origimg).append($img);if(options.addClass){$div.addClass(options.addClass)}var $img2=$("<div />"),$img_holder=$("<div />").width("100%").height("100%").css({zIndex:310,position:"absolute",overflow:"hidden"}),$hdl_holder=$("<div />").width("100%").height("100%").css("zIndex",320),$sel=$("<div />").css({position:"absolute",zIndex:600}).dblclick(function(){var c=Coords.getFixed();options.onDblClick.call(api,c)}).insertBefore($img).append($img_holder,$hdl_holder);if(img_mode){$img2=$("<img />").attr("src",$img.attr("src")).css(img_css).width(boundx).height(boundy),$img_holder.append($img2)}if(ie6mode){$sel.css({overflowY:"hidden"})}var bound=options.boundary;var $trk=newTracker().width(boundx+bound*2).height(boundy+bound*2).css({position:"absolute",top:px(-bound),left:px(-bound),zIndex:290}).mousedown(newSelection);var bgcolor=options.bgColor,bgopacity=options.bgOpacity,xlimit,ylimit,xmin,ymin,xscale,yscale,enabled=true,btndown,animating,shift_down;docOffset=getPos($img);var Touch=function(){function hasTouchSupport(){var support={},events=["touchstart","touchmove","touchend"],el=document.createElement("div"),i;try{for(i=0;i<events.length;i++){var eventName=events[i];eventName="on"+eventName;var isSupported=eventName in el;if(!isSupported){el.setAttribute(eventName,"return;");isSupported=typeof el[eventName]=="function"}support[events[i]]=isSupported}return support.touchstart&&support.touchend&&support.touchmove}catch(err){return false}}function detectSupport(){if(options.touchSupport===true||options.touchSupport===false)return options.touchSupport;else return hasTouchSupport()}return{createDragger:function(ord){return function(e){if(options.disabled){return false}if(ord==="move"&&!options.allowMove){return false}docOffset=getPos($img);btndown=true;startDragMode(ord,mouseAbs(Touch.cfilter(e)),true);e.stopPropagation();e.preventDefault();return false}},newSelection:function(e){return newSelection(Touch.cfilter(e))},cfilter:function(e){e.pageX=e.originalEvent.changedTouches[0].pageX;e.pageY=e.originalEvent.changedTouches[0].pageY;return e},isSupported:hasTouchSupport,support:detectSupport()}}();var Coords=function(){var x1=0,y1=0,x2=0,y2=0,ox,oy;function setPressed(pos){pos=rebound(pos);x2=x1=pos[0];y2=y1=pos[1]}function setCurrent(pos){pos=rebound(pos);ox=pos[0]-x2;oy=pos[1]-y2;x2=pos[0];y2=pos[1]}function getOffset(){return[ox,oy]}function moveOffset(offset){var ox=offset[0],oy=offset[1];if(0>x1+ox){ox-=ox+x1}if(0>y1+oy){oy-=oy+y1}if(boundy<y2+oy){oy+=boundy-(y2+oy)}if(boundx<x2+ox){ox+=boundx-(x2+ox)}x1+=ox;x2+=ox;y1+=oy;y2+=oy}function getCorner(ord){var c=getFixed();switch(ord){case"ne":return[c.x2,c.y];case"nw":return[c.x,c.y];case"se":return[c.x2,c.y2];case"sw":return[c.x,c.y2]}}function getFixed(){if(!options.aspectRatio){return getRect()}var aspect=options.aspectRatio,min_x=options.minSize[0]/xscale,max_x=options.maxSize[0]/xscale,max_y=options.maxSize[1]/yscale,rw=x2-x1,rh=y2-y1,rwa=Math.abs(rw),rha=Math.abs(rh),real_ratio=rwa/rha,xx,yy,w,h;if(max_x===0){max_x=boundx*10}if(max_y===0){max_y=boundy*10}if(real_ratio<aspect){yy=y2;w=rha*aspect;xx=rw<0?x1-w:w+x1;if(xx<0){xx=0;h=Math.abs((xx-x1)/aspect);yy=rh<0?y1-h:h+y1}else if(xx>boundx){xx=boundx;h=Math.abs((xx-x1)/aspect);yy=rh<0?y1-h:h+y1}}else{xx=x2;h=rwa/aspect;yy=rh<0?y1-h:y1+h;if(yy<0){yy=0;w=Math.abs((yy-y1)*aspect);xx=rw<0?x1-w:w+x1}else if(yy>boundy){yy=boundy;w=Math.abs(yy-y1)*aspect;xx=rw<0?x1-w:w+x1}}if(xx>x1){if(xx-x1<min_x){xx=x1+min_x}else if(xx-x1>max_x){xx=x1+max_x}if(yy>y1){yy=y1+(xx-x1)/aspect}else{yy=y1-(xx-x1)/aspect}}else if(xx<x1){if(x1-xx<min_x){xx=x1-min_x}else if(x1-xx>max_x){xx=x1-max_x}if(yy>y1){yy=y1+(x1-xx)/aspect}else{yy=y1-(x1-xx)/aspect}}if(xx<0){x1-=xx;xx=0}else if(xx>boundx){x1-=xx-boundx;xx=boundx}if(yy<0){y1-=yy;yy=0}else if(yy>boundy){y1-=yy-boundy;yy=boundy}return makeObj(flipCoords(x1,y1,xx,yy))}function rebound(p){if(p[0]<0)p[0]=0;if(p[1]<0)p[1]=0;if(p[0]>boundx)p[0]=boundx;if(p[1]>boundy)p[1]=boundy;return[Math.round(p[0]),Math.round(p[1])]}function flipCoords(x1,y1,x2,y2){var xa=x1,xb=x2,ya=y1,yb=y2;if(x2<x1){xa=x2;xb=x1}if(y2<y1){ya=y2;yb=y1}return[xa,ya,xb,yb]}function getRect(){var xsize=x2-x1,ysize=y2-y1,delta;if(xlimit&&Math.abs(xsize)>xlimit){x2=xsize>0?x1+xlimit:x1-xlimit}if(ylimit&&Math.abs(ysize)>ylimit){y2=ysize>0?y1+ylimit:y1-ylimit}if(ymin/yscale&&Math.abs(ysize)<ymin/yscale){y2=ysize>0?y1+ymin/yscale:y1-ymin/yscale}if(xmin/xscale&&Math.abs(xsize)<xmin/xscale){x2=xsize>0?x1+xmin/xscale:x1-xmin/xscale}if(x1<0){x2-=x1;x1-=x1}if(y1<0){y2-=y1;y1-=y1}if(x2<0){x1-=x2;x2-=x2}if(y2<0){y1-=y2;y2-=y2}if(x2>boundx){delta=x2-boundx;x1-=delta;x2-=delta}if(y2>boundy){delta=y2-boundy;y1-=delta;y2-=delta}if(x1>boundx){delta=x1-boundy;y2-=delta;y1-=delta}if(y1>boundy){delta=y1-boundy;y2-=delta;y1-=delta}return makeObj(flipCoords(x1,y1,x2,y2))}function makeObj(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]}}return{flipCoords:flipCoords,setPressed:setPressed,setCurrent:setCurrent,getOffset:getOffset,moveOffset:moveOffset,getCorner:getCorner,getFixed:getFixed}}();var Shade=function(){var enabled=false,holder=$("<div />").css({position:"absolute",zIndex:240,opacity:0}),shades={top:createShade(),left:createShade().height(boundy),right:createShade().height(boundy),bottom:createShade()};function resizeShades(w,h){shades.left.css({height:px(h)});shades.right.css({height:px(h)})}function updateAuto(){return updateShade(Coords.getFixed())}function updateShade(c){shades.top.css({left:px(c.x),width:px(c.w),height:px(c.y)});shades.bottom.css({top:px(c.y2),left:px(c.x),width:px(c.w),height:px(boundy-c.y2)});shades.right.css({left:px(c.x2),width:px(boundx-c.x2)});shades.left.css({width:px(c.x)})}function createShade(){return $("<div />").css({position:"absolute",backgroundColor:options.shadeColor||options.bgColor}).appendTo(holder)}function enableShade(){if(!enabled){enabled=true;holder.insertBefore($img);updateAuto();Selection.setBgOpacity(1,0,1);$img2.hide();setBgColor(options.shadeColor||options.bgColor,1);if(Selection.isAwake()){setOpacity(options.bgOpacity,1)}else setOpacity(1,1)}}function setBgColor(color,now){colorChangeMacro(getShades(),color,now)}function disableShade(){if(enabled){holder.remove();$img2.show();enabled=false;if(Selection.isAwake()){Selection.setBgOpacity(options.bgOpacity,1,1)}else{Selection.setBgOpacity(1,1,1);Selection.disableHandles()}colorChangeMacro($div,0,1)}}function setOpacity(opacity,now){if(enabled){if(options.bgFade&&!now){holder.animate({opacity:1-opacity},{queue:false,duration:options.fadeTime})}else holder.css({opacity:1-opacity})}}function refreshAll(){options.shade?enableShade():disableShade();if(Selection.isAwake())setOpacity(options.bgOpacity)}function getShades(){return holder.children()}return{update:updateAuto,updateRaw:updateShade,getShades:getShades,setBgColor:setBgColor,enable:enableShade,disable:disableShade,resize:resizeShades,refresh:refreshAll,opacity:setOpacity}}();var Selection=function(){var awake,hdep=370,borders={},handle={},dragbar={},seehandles=false;function insertBorder(type){var jq=$("<div />").css({position:"absolute",opacity:options.borderOpacity}).addClass(cssClass(type));$img_holder.append(jq);return jq}function dragDiv(ord,zi){var jq=$("<div />").mousedown(createDragger(ord)).css({cursor:ord+"-resize",position:"absolute",zIndex:zi}).addClass("ord-"+ord);if(Touch.support){jq.bind("touchstart.jcrop",Touch.createDragger(ord))}$hdl_holder.append(jq);return jq}function insertHandle(ord){var hs=options.handleSize,div=dragDiv(ord,hdep++).css({opacity:options.handleOpacity}).addClass(cssClass("handle"));if(hs){div.width(hs).height(hs)}return div}function insertDragbar(ord){return dragDiv(ord,hdep++).addClass("jcrop-dragbar")}function createDragbars(li){var i;for(i=0;i<li.length;i++){dragbar[li[i]]=insertDragbar(li[i])}}function createBorders(li){var cl,i;for(i=0;i<li.length;i++){switch(li[i]){case"n":cl="hline";break;case"s":cl="hline bottom";break;case"e":cl="vline right";break;case"w":cl="vline";break}borders[li[i]]=insertBorder(cl)}}function createHandles(li){var i;for(i=0;i<li.length;i++){handle[li[i]]=insertHandle(li[i])}}function moveto(x,y){if(!options.shade){$img2.css({top:px(-y),left:px(-x)})}$sel.css({top:px(y),left:px(x)})}function resize(w,h){$sel.width(Math.round(w)).height(Math.round(h))}function refresh(){var c=Coords.getFixed();Coords.setPressed([c.x,c.y]);Coords.setCurrent([c.x2,c.y2]);updateVisible()}function updateVisible(select){if(awake){return update(select)}}function update(select){var c=Coords.getFixed();resize(c.w,c.h);moveto(c.x,c.y);if(options.shade)Shade.updateRaw(c);awake||show();if(select){options.onSelect.call(api,unscale(c))}else{options.onChange.call(api,unscale(c))}}function setBgOpacity(opacity,force,now){if(!awake&&!force)return;if(options.bgFade&&!now){$img.animate({opacity:opacity},{queue:false,duration:options.fadeTime})}else{$img.css("opacity",opacity)}}function show(){$sel.show();if(options.shade)Shade.opacity(bgopacity);else setBgOpacity(bgopacity,true);awake=true}function release(){disableHandles();$sel.hide();if(options.shade)Shade.opacity(1);else setBgOpacity(1);awake=false;options.onRelease.call(api)}function showHandles(){if(seehandles){$hdl_holder.show()}}function enableHandles(){seehandles=true;if(options.allowResize){$hdl_holder.show();return true}}function disableHandles(){seehandles=false;$hdl_holder.hide()}function animMode(v){if(v){animating=true;disableHandles()}else{animating=false;enableHandles()}}function done(){animMode(false);refresh()}if(options.dragEdges&&$.isArray(options.createDragbars))createDragbars(options.createDragbars);if($.isArray(options.createHandles))createHandles(options.createHandles);if(options.drawBorders&&$.isArray(options.createBorders))createBorders(options.createBorders);$(document).bind("touchstart.jcrop-ios",function(e){if($(e.currentTarget).hasClass("jcrop-tracker"))e.stopPropagation()});var $track=newTracker().mousedown(createDragger("move")).css({cursor:"move",position:"absolute",zIndex:360});if(Touch.support){$track.bind("touchstart.jcrop",Touch.createDragger("move"))}$img_holder.append($track);disableHandles();return{updateVisible:updateVisible,update:update,release:release,refresh:refresh,isAwake:function(){return awake},setCursor:function(cursor){$track.css("cursor",cursor)},enableHandles:enableHandles,enableOnly:function(){seehandles=true},showHandles:showHandles,disableHandles:disableHandles,animMode:animMode,setBgOpacity:setBgOpacity,done:done}}();var Tracker=function(){var onMove=function(){},onDone=function(){},trackDoc=options.trackDocument;function toFront(touch){$trk.css({zIndex:450});if(touch)$(document).bind("touchmove.jcrop",trackTouchMove).bind("touchend.jcrop",trackTouchEnd);else if(trackDoc)$(document).bind("mousemove.jcrop",trackMove).bind("mouseup.jcrop",trackUp)}function toBack(){$trk.css({zIndex:290});$(document).unbind(".jcrop")}function trackMove(e){onMove(mouseAbs(e));return false}function trackUp(e){e.preventDefault();e.stopPropagation();if(btndown){btndown=false;onDone(mouseAbs(e));if(Selection.isAwake()){options.onSelect.call(api,unscale(Coords.getFixed()))}toBack();onMove=function(){};onDone=function(){}}return false}function activateHandlers(move,done,touch){btndown=true;onMove=move;onDone=done;toFront(touch);return false}function trackTouchMove(e){onMove(mouseAbs(Touch.cfilter(e)));return false}function trackTouchEnd(e){return trackUp(Touch.cfilter(e))}function setCursor(t){$trk.css("cursor",t)}if(!trackDoc){$trk.mousemove(trackMove).mouseup(trackUp).mouseout(trackUp)}$img.before($trk);return{activateHandlers:activateHandlers,setCursor:setCursor}}();var KeyManager=function(){var $keymgr=$('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}).addClass("jcrop-keymgr"),$keywrap=$("<div />").css({position:"absolute",overflow:"hidden"}).append($keymgr);function watchKeys(){if(options.keySupport){$keymgr.show();$keymgr.focus()}}function onBlur(e){$keymgr.hide()}function doNudge(e,x,y){if(options.allowMove){Coords.moveOffset([x,y]);Selection.updateVisible(true)}e.preventDefault();e.stopPropagation()}function parseKey(e){if(e.ctrlKey||e.metaKey){return true}shift_down=e.shiftKey?true:false;var nudge=shift_down?10:1;switch(e.keyCode){case 37:doNudge(e,-nudge,0);break;case 39:doNudge(e,nudge,0);break;case 38:doNudge(e,0,-nudge);break;case 40:doNudge(e,0,nudge);break;case 27:if(options.allowSelect)Selection.release();break;case 9:return true}return false}if(options.keySupport){$keymgr.keydown(parseKey).blur(onBlur);if(ie6mode||!options.fixedSupport){$keymgr.css({position:"absolute",left:"-20px"});$keywrap.append($keymgr).insertBefore($img)}else{$keymgr.insertBefore($img)}}return{watchKeys:watchKeys}}();function setClass(cname){$div.removeClass().addClass(cssClass("holder")).addClass(cname)}function animateTo(a,callback){var x1=a[0]/xscale,y1=a[1]/yscale,x2=a[2]/xscale,y2=a[3]/yscale;if(animating){return}var animto=Coords.flipCoords(x1,y1,x2,y2),c=Coords.getFixed(),initcr=[c.x,c.y,c.x2,c.y2],animat=initcr,interv=options.animationDelay,ix1=animto[0]-initcr[0],iy1=animto[1]-initcr[1],ix2=animto[2]-initcr[2],iy2=animto[3]-initcr[3],pcent=0,velocity=options.swingSpeed;x1=animat[0];y1=animat[1];x2=animat[2];y2=animat[3];Selection.animMode(true);var anim_timer;function queueAnimator(){window.setTimeout(animator,interv)}var animator=function(){return function(){pcent+=(100-pcent)/velocity;animat[0]=Math.round(x1+pcent/100*ix1);animat[1]=Math.round(y1+pcent/100*iy1);animat[2]=Math.round(x2+pcent/100*ix2);animat[3]=Math.round(y2+pcent/100*iy2);if(pcent>=99.8){pcent=100}if(pcent<100){setSelectRaw(animat);queueAnimator()}else{Selection.done();Selection.animMode(false);if(typeof callback==="function"){callback.call(api)}}}}();queueAnimator()}function setSelect(rect){setSelectRaw([rect[0]/xscale,rect[1]/yscale,rect[2]/xscale,rect[3]/yscale]);options.onSelect.call(api,unscale(Coords.getFixed()));Selection.enableHandles()}function setSelectRaw(l){Coords.setPressed([l[0],l[1]]);Coords.setCurrent([l[2],l[3]]);Selection.update()}function tellSelect(){return unscale(Coords.getFixed())}function tellScaled(){return Coords.getFixed()}function setOptionsNew(opt){setOptions(opt);interfaceUpdate()}function disableCrop(){options.disabled=true;Selection.disableHandles();Selection.setCursor("default");Tracker.setCursor("default")}function enableCrop(){options.disabled=false;interfaceUpdate()}function cancelCrop(){Selection.done();Tracker.activateHandlers(null,null)}function destroy(){$div.remove();$origimg.show();$origimg.css("visibility","visible");$(obj).removeData("Jcrop")}function setImage(src,callback){Selection.release();disableCrop();var img=new Image;img.onload=function(){var iw=img.width;var ih=img.height;var bw=options.boxWidth;var bh=options.boxHeight;$img.width(iw).height(ih);$img.attr("src",src);$img2.attr("src",src);presize($img,bw,bh);boundx=$img.width();boundy=$img.height();$img2.width(boundx).height(boundy);$trk.width(boundx+bound*2).height(boundy+bound*2);$div.width(boundx).height(boundy);Shade.resize(boundx,boundy);enableCrop();if(typeof callback==="function"){callback.call(api)}};img.src=src}function colorChangeMacro($obj,color,now){var mycolor=color||options.bgColor;if(options.bgFade&&supportsColorFade()&&options.fadeTime&&!now){$obj.animate({backgroundColor:mycolor},{queue:false,duration:options.fadeTime})}else{$obj.css("backgroundColor",mycolor)}}function interfaceUpdate(alt){if(options.allowResize){if(alt){Selection.enableOnly()}else{Selection.enableHandles()}}else{Selection.disableHandles()}Tracker.setCursor(options.allowSelect?"crosshair":"default");Selection.setCursor(options.allowMove?"move":"default");if(options.hasOwnProperty("trueSize")){xscale=options.trueSize[0]/boundx;yscale=options.trueSize[1]/boundy}if(options.hasOwnProperty("setSelect")){setSelect(options.setSelect);Selection.done();delete options.setSelect}Shade.refresh();if(options.bgColor!=bgcolor){colorChangeMacro(options.shade?Shade.getShades():$div,options.shade?options.shadeColor||options.bgColor:options.bgColor);bgcolor=options.bgColor}if(bgopacity!=options.bgOpacity){bgopacity=options.bgOpacity;if(options.shade)Shade.refresh();else Selection.setBgOpacity(bgopacity)}xlimit=options.maxSize[0]||0;ylimit=options.maxSize[1]||0;xmin=options.minSize[0]||0;ymin=options.minSize[1]||0;if(options.hasOwnProperty("outerImage")){$img.attr("src",options.outerImage);delete options.outerImage}Selection.refresh()}if(Touch.support)$trk.bind("touchstart.jcrop",Touch.newSelection);$hdl_holder.hide();interfaceUpdate(true);var api={setImage:setImage,animateTo:animateTo,setSelect:setSelect,setOptions:setOptionsNew,tellSelect:tellSelect,tellScaled:tellScaled,setClass:setClass,disable:disableCrop,enable:enableCrop,cancel:cancelCrop,release:Selection.release,destroy:destroy,focus:KeyManager.watchKeys,getBounds:function(){return[boundx*xscale,boundy*yscale]},getWidgetSize:function(){return[boundx,boundy]},getScaleFactor:function(){return[xscale,yscale]},getOptions:function(){return options},ui:{holder:$div,selection:$sel}};if(is_msie)$div.bind("selectstart",function(){return false});$origimg.data("Jcrop",api);return api};$.fn.Jcrop=function(options,callback){var api;this.each(function(){if($(this).data("Jcrop")){if(options==="api")return $(this).data("Jcrop");else $(this).data("Jcrop").setOptions(options)}else{if(this.tagName=="IMG")$.Jcrop.Loader(this,function(){$(this).css({display:"block",visibility:"hidden"});api=$.Jcrop(this,options);if($.isFunction(callback))callback.call(api)});else{$(this).css({display:"block",visibility:"hidden"});api=$.Jcrop(this,options);if($.isFunction(callback))callback.call(api)}}});return this};$.Jcrop.Loader=function(imgobj,success,error){var $img=$(imgobj),img=$img[0];function completeCheck(){if(img.complete){$img.unbind(".jcloader");if($.isFunction(success))success.call(img)}else window.setTimeout(completeCheck,50)}$img.bind("load.jcloader",completeCheck).bind("error.jcloader",function(e){$img.unbind(".jcloader");if($.isFunction(error))error.call(img)});if(img.complete&&$.isFunction(success)){$img.unbind(".jcloader");success.call(img)}};$.Jcrop.defaults={allowSelect:true,allowMove:true,allowResize:true,trackDocument:true,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:.6,bgFade:false,borderOpacity:.4,handleOpacity:.5,handleSize:null,aspectRatio:0,keySupport:true,createHandles:["n","s","e","w","nw","ne","se","sw"],createDragbars:["n","s","e","w"],createBorders:["n","s","e","w"],drawBorders:true,dragEdges:true,fixedSupport:true,touchSupport:null,shade:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onDblClick:function(){},onRelease:function(){}}})(jQuery);